<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­è²¡å‹™å°å¸³è¨ˆç®—æ©Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* ç¢ºä¿å­—é«”ç‚º Inter */
        body {
            font-family: 'Inter', sans-serif;
            /* æ·±åº¦æ·±è—è‰²èƒŒæ™¯ (Tailwind Slate-900) */
            background-color: #0f172a; 
            /* é è¨­æ–‡å­—é¡è‰²æ”¹ç‚ºæ·ºè‰² */
            color: #e2e8f0; /* Slate-200 */
        }
        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* æ•¸å­—è¼¸å…¥æ¡†ä½¿ç”¨æ¨™æº–å­—é«” (ç¢ºä¿æ­£å¸¸çš„ 0) */
        .standard-digit-input {
            font-family: 'Inter', sans-serif; 
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
        }
        /* å·®ç•°é¡¯ç¤ºå€çš„æ•¸å­—ä¹Ÿä½¿ç”¨æ¨™æº–å­—é«” */
        .difference-digit-display {
            font-family: 'Inter', sans-serif;
            font-weight: 900; /* font-extrabold */
        }

        /* èª¿æ•´ä¸»è¦å®¹å™¨èƒŒæ™¯ç‚ºæ›´æ·±è‰²ï¼Œä¿ç•™çµ‚ç«¯æ©Ÿé…è‰²åŸºèª¿ */
        #app-container {
            /* å¹¾ä¹ç´”é»‘ */
            background-color: #121212; 
            /* çµ‚ç«¯æ©Ÿç™¼å…‰é‚Šæ¡†æ•ˆæœ */
            border: 1px solid #00b4ff20; 
            box-shadow: 0 0 10px rgba(0, 180, 255, 0.2), 0 0 30px rgba(0, 180, 255, 0.1); 
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app-container" class="w-full max-w-xl rounded-2xl p-6 sm:p-8">
        <h1 class="text-3xl font-extrabold text-cyan-400 mb-6 text-center border-b pb-3 border-gray-700">
            ğŸ“Š å°ˆæ¥­è²¡å‹™å°å¸³è¨ˆç®—å„€è¡¨æ¿
        </h1>

        <div class="bg-gray-800 border-l-4 border-green-500 text-green-300 p-4 rounded-lg mb-6 shadow-md">
            <p class="font-bold mb-2 text-lg">å°å¸³ç›®æ¨™ï¼š<span class="text-green-400">å·®ç•°ç‚º 0</span></p>
            <p class="text-sm font-medium italic text-gray-400">
                å…¬å¼ï¼š(POS æ”¶å…¥) - (é å”®çµå¸³ + AC+) - (SKM1 + SKM2 + ç†Ÿå®¢ + å¤–å¸³) = å·®ç•°
            </p>
            <ul class="list-disc list-inside mt-3 text-sm space-y-1">
                <li class="text-green-400"><span class="font-bold text-cyan-400">æ­£å€¼ (+)</span>: æ–°å…‰å°‘æ”¶éŒ¢ (éœ€è¿½è¹¤æ˜ç´°é€€æ¬¾)</li>
                <li class="text-red-400"><span class="font-bold text-cyan-400">è² å€¼ (-)</span>: æ–°å…‰å¤šæ”¶éŒ¢ (éœ€è¿½è¹¤æ˜ç´°å…¥å¸³)</li>
            </ul>
        </div>

        <div id="inputs-container" class="space-y-4">
            
            <h2 class="text-xl font-bold text-cyan-400 pt-4 mb-2 border-t border-gray-800">POS éŠ·è²¨é …ç›® (æ”¶å…¥)</h2>
            <div class="grid grid-cols-3 gap-4">
                
                <div class="input-group col-span-3">
                    <label for="paymentTotal" class="block text-sm font-medium text-gray-300">Payment Total (ç¸½æ”¶å…¥)</label>
                    <input type="text" id="paymentTotal" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border border-gray-700 rounded-lg shadow-inner focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 ease-in-out standard-digit-input text-left bg-gray-900 text-white font-bold">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="preSaleSettlement" class="block text-sm font-medium text-gray-300">é å”®çµå¸³ (æ¸›é …)</label>
                    <input type="text" id="preSaleSettlement" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border border-gray-700 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 ease-in-out standard-digit-input text-left bg-gray-900 text-white">
                </div>

                <div class="input-group">
                    <label for="acPlus" class="block text-sm font-medium text-gray-300">AC+ (æ¸›é …)</label>
                    <input type="text" id="acPlus" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border border-gray-700 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 ease-in-out standard-digit-input text-left bg-gray-900 text-white">
                </div>
            </div>
            
            <h2 class="text-xl font-bold text-cyan-400 pt-4 border-t border-gray-800 mt-6 mb-2">æ–°å…‰/å¤–å¸³ (æ‡‰æ”¶é …ç›®)</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="skm1Amount" class="block text-sm font-medium text-gray-300">SKM 1</label>
                    <input type="text" id="skm1Amount" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border border-gray-700 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 ease-in-out standard-digit-input text-left bg-gray-900 text-white">
                </div>
                
                <div class="input-group">
                    <label for="skm2Amount" class="block text-sm font-medium text-gray-300">SKM 2</label>
                    <input type="text" id="skm2Amount" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border border-gray-700 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 ease-in-out standard-digit-input text-left bg-gray-900 text-white">
                </div>

                <div class="input-group">
                    <label for="skmLoyalCustomer" class="block text-sm font-medium text-gray-300">SKM ç†Ÿå®¢</label>
                    <input type="text" id="skmLoyalCustomer" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border border-gray-700 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 ease-in-out standard-digit-input text-left bg-gray-900 text-white">
                </div>
                
                <div class="input-group">
                    <label for="externalAccount" class="block text-sm font-medium text-gray-300">å¤–å¸³</label>
                    <input type="text" id="externalAccount" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border border-gray-700 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 ease-in-out standard-digit-input text-left bg-gray-900 text-white">
                </div>
            </div>
        </div>

        <div class="mt-10 pt-6 border-t border-cyan-500">
            <h2 class="text-xl font-bold text-white mb-4 text-center">ğŸ‰ æœ€çµ‚å°å¸³çµæœ ğŸ‰</h2>
            <div id="difference-display" class="p-6 rounded-xl shadow-xl text-center transition duration-300 ease-in-out bg-gray-900 border border-cyan-500">
                <p class="text-7xl difference-digit-display transition-colors duration-300 text-white" id="difference-value">0</p>
            </div>
            <p id="reconciliation-status" class="mt-4 text-center text-xl font-semibold text-slate-200"></p>
        </div>

        <p id="loading-status" class="mt-6 text-center text-sm text-gray-500">
            <span class="animate-pulse text-yellow-500">æ•¸æ“šåŒæ­¥ä¸­...</span>
        </p>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // è¨­ç½®æ—¥èªŒç´šåˆ¥ç‚º Debug (å¯é¸)
        setLogLevel('Debug');

        // --- 1. åˆå§‹åŒ– Firebase ç›¸é—œå¸¸æ•¸å’Œè®Šæ•¸ ---
        let db, auth, userId;
        let isAuthReady = false;
        
        // å¾ Canvas ç’°å¢ƒè®Šæ•¸ç²å–é…ç½®
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // æ›´æ–° INPUT_IDS ä»¥åŒ…å«æ‰€æœ‰æ¬„ä½
        const INPUT_IDS = ['paymentTotal', 'preSaleSettlement', 'acPlus', 'skm1Amount', 'skm2Amount', 'externalAccount', 'skmLoyalCustomer'];
        const DIFF_VALUE_EL = document.getElementById('difference-value');
        const STATUS_EL = document.getElementById('reconciliation-status');
        const LOADING_EL = document.getElementById('loading-status');
        
        // --- Helper å‡½æ•¸ï¼šè™•ç†æ•¸å­—æ ¼å¼åŒ– ---

        /**
         * ç§»é™¤æ•¸å­—å­—ä¸²ä¸­çš„æ‰€æœ‰éæ•¸å­—å­—ç¬¦ï¼ˆåŒ…å«åƒåˆ†ä½ç¬¦è™Ÿï¼‰ï¼Œä½†ä¿ç•™å°æ•¸é»å’Œè² è™Ÿã€‚
         * @param {string | number} value - å¾…æ¸…ç†çš„å€¼ã€‚
         * @returns {string} æ¸…ç†å¾Œçš„æ•¸å­—å­—ä¸²ã€‚
         */
        function unformatNumber(value) {
            if (typeof value !== 'string') value = String(value);
            // å…è¨±æ•¸å­—ã€å°æ•¸é»å’Œé–‹é ­çš„è² è™Ÿ
            const cleaned = value.replace(/,/g, ''); // ç§»é™¤æ‰€æœ‰é€—è™Ÿ
            // ä¿ç•™æ•¸å­—ã€å°æ•¸é»ã€å’Œé–‹é ­çš„è² è™Ÿï¼Œä¸¦è™•ç†å¤šå€‹è² è™Ÿæˆ–å°æ•¸é»çš„æƒ…æ³ï¼ˆåªå–ç¬¬ä¸€å€‹ï¼‰
            let result = cleaned.replace(/[^-0-9.]/g, '');
            // ç¢ºä¿åªæœ‰ç¬¬ä¸€å€‹å­—ç¬¦æ˜¯è² è™Ÿ
            if (result.indexOf('-') > 0) {
                result = result.replace(/-/g, '');
            }
            // ç¢ºä¿åªæœ‰ä¸€å€‹å°æ•¸é»
            if ((result.match(/\./g) || []).length > 1) {
                const parts = result.split('.');
                result = parts.shift() + '.' + parts.join('');
            }
            return result;
        }

        /**
         * å°‡æ•¸å­—æˆ–æ•¸å­—å­—ä¸²æ ¼å¼åŒ–ç‚ºå¸¶æœ‰åƒä½æ•¸åˆ†éš”ç¬¦è™Ÿçš„å­—ä¸²ã€‚
         * @param {string | number} value - å¾…æ ¼å¼åŒ–çš„å€¼ã€‚
         * @returns {string} å¸¶æœ‰åƒåˆ†ä½ç¬¦è™Ÿçš„å­—ä¸²ã€‚
         */
        function formatNumberWithCommas(value) {
            const cleanedValue = unformatNumber(value);
            if (cleanedValue === '' || cleanedValue === '-') return cleanedValue;

            // ä½¿ç”¨ Intl.NumberFormat ç¢ºä¿æº–ç¢ºçš„åƒåˆ†ä½æ ¼å¼
            // ä½¿ç”¨ 'en-US' ç¢ºä¿ä½¿ç”¨é€—è™Ÿä½œç‚ºåƒåˆ†ä½åˆ†éš”ç¬¦
            return new Intl.NumberFormat('en-US').format(parseFloat(cleanedValue));
        }

        // --- 2. æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---
        function calculateDifference() {
            // å¾è¼¸å…¥æ¡†ç²å–æ•¸å€¼ (å…ˆå»é™¤åƒåˆ†ä½ç¬¦è™Ÿ)ï¼Œå¦‚æœç‚ºç©ºå‰‡è¦–ç‚º 0
            const paymentTotalStr = unformatNumber(document.getElementById('paymentTotal').value);
            const preSaleSettlementStr = unformatNumber(document.getElementById('preSaleSettlement').value);
            const acPlusStr = unformatNumber(document.getElementById('acPlus').value);
            const skm1AmountStr = unformatNumber(document.getElementById('skm1Amount').value); 
            const skm2AmountStr = unformatNumber(document.getElementById('skm2Amount').value); 
            const externalAccountStr = unformatNumber(document.getElementById('externalAccount').value);
            // è®€å– SKM ç†Ÿå®¢
            const skmLoyalCustomerStr = unformatNumber(document.getElementById('skmLoyalCustomer').value); 

            // è½‰æ›ç‚ºæµ®é»æ•¸é€²è¡Œè¨ˆç®—
            // ç•¶è¼¸å…¥ç‚ºç©ºå­—ä¸² '' æ™‚ï¼ŒparseFloat(unformatNumber('')) || 0 æœƒå¾—åˆ° 0
            const paymentTotal = parseFloat(paymentTotalStr) || 0;
            const preSaleSettlement = parseFloat(preSaleSettlementStr) || 0;
            const acPlus = parseFloat(acPlusStr) || 0;
            const skm1Amount = parseFloat(skm1AmountStr) || 0;
            const skm2Amount = parseFloat(skm2AmountStr) || 0;
            const externalAccount = parseFloat(externalAccountStr) || 0;
            const skmLoyalCustomer = parseFloat(skmLoyalCustomerStr) || 0; 

            // è¨ˆç®—å·®ç•°ï¼š(Payment Total - é å”®çµå¸³ - AC+) - (SKM1 + SKM2 + SKM ç†Ÿå®¢ + å¤–å¸³)
            const difference = paymentTotal
                             - (preSaleSettlement + acPlus)
                             - (skm1Amount + skm2Amount + skmLoyalCustomer + externalAccount);

            // ç¢ºä¿åªå–å…©ä½å°æ•¸é»ï¼Œé¿å…æµ®é»æ•¸èª¤å·®
            return parseFloat(difference.toFixed(2));
        }

        // --- 3. æ›´æ–° UI é¡¯ç¤º ---
        function updateUI() {
            const difference = calculateDifference();
            
            // å·®ç•°é¡¯ç¤ºä»å¥—ç”¨åƒåˆ†ä½ç¬¦è™Ÿ
            DIFF_VALUE_EL.textContent = difference.toLocaleString('en-US');

            // ç§»é™¤æ‰€æœ‰é¡è‰²é¡åˆ¥
            DIFF_VALUE_EL.parentElement.classList.remove('bg-green-900', 'bg-red-900', 'border-green-400', 'border-red-400', 'bg-gray-900', 'border-cyan-500');
            DIFF_VALUE_EL.classList.remove('text-green-300', 'text-red-300', 'text-white');
            STATUS_EL.classList.remove('text-green-400', 'text-red-400', 'text-slate-200');

            if (difference === 0) {
                // å¹³å¸³ - çµ‚ç«¯æ©Ÿç¶ è‰²
                DIFF_VALUE_EL.parentElement.classList.add('bg-green-900', 'border-green-400');
                DIFF_VALUE_EL.classList.add('text-green-300');
                STATUS_EL.textContent = 'âœ… æ­å–œï¼ä»Šæ—¥å°å¸³ç„¡å·®ç•°ï¼';
                STATUS_EL.classList.add('text-green-400');
            } else if (difference > 0) {
                // æ­£å·®ç•° - çµ‚ç«¯æ©Ÿç´…è‰²/æ©™è‰²
                DIFF_VALUE_EL.parentElement.classList.add('bg-red-900', 'border-red-400');
                DIFF_VALUE_EL.classList.add('text-red-300');
                STATUS_EL.textContent = `ğŸš¨ å·®ç•° +${difference.toLocaleString('en-US')} (æ–°å…‰å°‘æ”¶éŒ¢ï¼Œéœ€è¿½è¹¤æ˜ç´°)`;
                STATUS_EL.classList.add('text-red-400');
            } else {
                // è² å·®ç•° - çµ‚ç«¯æ©Ÿç´…è‰²/æ©™è‰²
                DIFF_VALUE_EL.parentElement.classList.add('bg-red-900', 'border-red-400');
                DIFF_VALUE_EL.classList.add('text-red-300');
                STATUS_EL.textContent = `ğŸš¨ å·®ç•° ${difference.toLocaleString('en-US')} (æ–°å…‰å¤šæ”¶éŒ¢ï¼Œéœ€è¿½è¹¤æ˜ç´°)`;
                STATUS_EL.classList.add('text-red-400');
            }
            
            // é è¨­æƒ…æ³ 
            if (difference === 0 && !DIFF_VALUE_EL.parentElement.classList.contains('bg-green-900')) {
                DIFF_VALUE_EL.parentElement.classList.add('bg-gray-900', 'border-cyan-500');
                DIFF_VALUE_EL.classList.add('text-white');
                STATUS_EL.classList.add('text-slate-200');
                STATUS_EL.textContent = 'è«‹è¼¸å…¥æ•¸å­—ä»¥é–‹å§‹å°å¸³...';
            }
        }

        // --- 4. Firestore æ•¸æ“šæ“ä½œ ---

        // å–å¾—å–®ä¸€æ–‡ä»¶è·¯å¾‘ (Private Data)
        function getDocRef() {
            if (!db || !userId) return null;
            // è·¯å¾‘ï¼š/artifacts/{appId}/users/{userId}/reconciliation_tool/current_state
            return doc(db, 'artifacts', appId, 'users', userId, 'reconciliation_tool', 'current_state');
        }

        // å„²å­˜æ•¸æ“šåˆ° Firestore
        async function saveData() {
            if (!isAuthReady) return; // ç¢ºä¿èªè­‰å®Œæˆ
            
            const docRef = getDocRef();
            if (!docRef) return;

            const dataToSave = {};
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                // 1. unformat the string (å»é™¤åƒåˆ†ä½ç¬¦è™Ÿ)
                const unformattedStr = unformatNumber(inputEl.value);
                // 2. convert to number for storage (å„²å­˜ç´”æ•¸å­—)
                // å³ä½¿æ˜¯ç©ºå­—ä¸²ï¼ŒparseFloat å¾Œä¹Ÿæœƒæ˜¯ NaNï¼Œé€é || 0 ç¢ºä¿å­˜å„²çš„æ˜¯ 0
                const value = parseFloat(unformattedStr) || 0;
                dataToSave[id] = value;
            });

            try {
                // ä½¿ç”¨ setDoc è¦†å¯«æˆ–å‰µå»ºæ–‡ä»¶
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // å¾ Firestore è¼‰å…¥æ•¸æ“šä¸¦è¨­å®šå³æ™‚ç›£è½
        function loadData() {
            const docRef = getDocRef();
            if (!docRef) return;

            // è¨­ç½® onSnapshot ç›£è½å™¨ä»¥å¯¦æ™‚ç²å–æ•¸æ“š
            onSnapshot(docRef, (docSnapshot) => {
                LOADING_EL.style.display = 'none'; // éš±è—è¼‰å…¥æç¤º
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    // å°‡æ•¸æ“šå¡«å……å›è¼¸å…¥æ¡†
                    INPUT_IDS.forEach(id => {
                        const inputEl = document.getElementById(id);
                        if (data[id] !== undefined && inputEl) {
                            const numericValue = data[id];
                            
                            // æ•¸å­— 0 é¡¯ç¤ºç‚º '' (ç©ºå­—ä¸²)
                            if (numericValue !== 0) {
                                // è¼‰å…¥æ™‚ï¼Œç›´æ¥é¡¯ç¤ºç´”æ•¸å­—
                                inputEl.value = numericValue.toString();
                            } else {
                                // å¦‚æœç‚º 0ï¼Œå‰‡é¡¯ç¤º '' (ç©ºå­—ä¸²)
                                inputEl.value = ''; 
                            }
                        }
                    });
                    console.log("Data loaded from Firestore successfully.");
                } else {
                    console.log("No data found, using default '' values.");
                    // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½è¨­å®šç‚º '' (ç©ºå­—ä¸²)
                    INPUT_IDS.forEach(id => {
                        const inputEl = document.getElementById(id);
                        if(inputEl) inputEl.value = '';
                    });
                }
                // ç„¡è«–è¼‰å…¥æˆåŠŸèˆ‡å¦ï¼Œéƒ½æ‡‰æ›´æ–° UI
                updateUI();
            }, (error) => {
                console.error("Error listening to Firestore data:", error);
                LOADING_EL.textContent = 'è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚';
                updateUI(); // ä»ç„¶ä½¿ç”¨ç•¶å‰è¼¸å…¥å€¼é€²è¡Œè¨ˆç®—
            });
        }

        // --- 5. äº‹ä»¶ç›£è½å™¨å’Œåˆå§‹åŒ– ---

        function setupEventListeners() {
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                if (inputEl) {
                    // ç›£è½è¼¸å…¥è®ŠåŒ–ï¼Œå³æ™‚æ›´æ–° UI 
                    inputEl.addEventListener('input', function() {
                        const caretPos = this.selectionStart;
                        
                        // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦ (ä¸å«åƒåˆ†ä½)
                        const cleanedValue = unformatNumber(this.value);
                        this.value = cleanedValue;
                        
                        // å˜—è©¦ä¿ç•™æ¸¸æ¨™ä½ç½®
                        this.setSelectionRange(caretPos, caretPos);

                        // æ›´æ–°è¨ˆç®—å’Œå„²å­˜
                        updateUI();
                        // ä½¿ç”¨ setTimeout é€²è¡Œç°¡å–®çš„å»æŠ–å‹• (debounce) ä»¥æ¸›å°‘å¯«å…¥æ¬¡æ•¸
                        clearTimeout(this.saveTimer);
                        this.saveTimer = setTimeout(saveData, 500);
                    });
                    
                    // ç›£è½ blur äº‹ä»¶
                    inputEl.addEventListener('blur', function() {
                        // ã€é—œéµä¿®æ­£ã€‘: åªè¦å€¼æ˜¯ ''ã€'-'ã€'.' æˆ– '0'ï¼Œå°±å¼·åˆ¶è¨­å®šç‚ºç©ºå­—ä¸² ''
                        if (this.value === '' || this.value === '-' || this.value === '.' || this.value === '0') {
                            this.value = ''; // ä¿æŒå–®å…ƒæ ¼è¦–è¦ºä¸Šç‚ºç©º
                            
                            updateUI(); // ç¢ºä¿ UI ç«‹å³æ›´æ–° (æ­¤æ™‚è¨ˆç®—å€¼ç‚º 0)
                            saveData(); // ç«‹å³å­˜å„² (è¼¸å…¥æ¡†ç‚º ''ï¼Œå­˜å„²ç‚º 0)
                        }
                    });
                }
            });
        }

        // Firebase åˆå§‹åŒ–å’Œèªè­‰æµç¨‹
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                LOADING_EL.textContent = 'Firebase é…ç½®ç¼ºå¤±ï¼Œæ•¸æ“šç„¡æ³•ä¿å­˜ã€‚';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // è™•ç†èªè­‰
                await new Promise((resolve) => {
                    // Firebase Auth ç‹€æ…‹è®Šæ›´ç›£è½
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // åªéœ€è¦ç›£è½ä¸€æ¬¡
                        if (user) {
                            userId = user.uid;
                        } else {
                            // ä½¿ç”¨æä¾›çš„ custom token ç™»å…¥ï¼Œå¦‚æœæ²’æœ‰å‰‡åŒ¿åç™»å…¥
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                console.log("Firebase Auth Ready. User ID:", userId);
                // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹è¼‰å…¥å’Œç›£è½æ•¸æ“š
                loadData();
                
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                LOADING_EL.textContent = 'Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—ã€‚';
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.onload = function() {
            setupEventListeners();
            updateUI();
            initializeFirebase();
        };

    </script>
</body>
</html>
