<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«‹å±•æ¥­ç¸¾å ±è¡¨åˆ†æ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid #3d3d3d;
        }

        h1 {
            color: #e0e0e0;
            font-size: 2em;
            margin-bottom: 8px;
        }

        .upload-section {
            background: #2d2d2d;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid #3d3d3d;
        }

        .upload-area {
            border: 3px dashed #4a9eff;
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #252525;
        }

        .upload-area:hover {
            background: #2a2a2a;
            border-color: #5db0ff;
        }

        .upload-area.dragover {
            background: #303030;
            border-color: #5db0ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #4a9eff;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1em;
            color: #b0b0b0;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            background: #3a8eef;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 158, 255, 0.4);
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        .store-card {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 1px solid #3d3d3d;
        }

        .store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
            border-color: #4a9eff;
        }

        .total-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
            border: 2px solid #4a9eff;
            grid-column: 1 / -1;
        }

        .total-card .store-name {
            color: #4a9eff;
            font-size: 1.7em;
            border-bottom-color: #4a9eff;
            border-bottom-width: 3px;
        }

        .store-name {
            font-size: 1.5em;
            color: #4a9eff;
            margin-bottom: 15px;
            font-weight: bold;
            border-bottom: 2px solid #4a4a4a;
            padding-bottom: 10px;
            text-align: left;
        }

        .metric-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #3d3d3d;
            gap: 15px;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 0.97em;
            color: #d0d0d0;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.15em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e0e0;
        }

        .positive {
            color: #34d399;
        }

        .negative {
            color: #f87171;
        }

        .neutral {
            color: #4a9eff;
        }

        .percentage {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .percentage.positive {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        .percentage.negative {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .amount {
            font-size: 0.8em;
            color: #888;
            margin-top: 3px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: #2d2d2d;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #3d3d3d;
        }

        .loading-spinner {
            border: 4px solid #3d3d3d;
            border-top: 4px solid #4a9eff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .summary-table-container {
            display: none;
            background: #2d2d2d;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
            border: 1px solid #3d3d3d;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .summary-table-container::-webkit-scrollbar {
            height: 8px;
        }

        .summary-table-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .summary-table-container::-webkit-scrollbar-thumb {
            background: #4a9eff;
            border-radius: 10px;
        }

        .summary-table-container::-webkit-scrollbar-thumb:hover {
            background: #6bb0ff;
        }

        .scroll-hint {
            display: none;
            text-align: center;
            color: #888;
            font-size: 0.85em;
            padding: 5px;
            margin-top: 10px;
        }

        .summary-table-title {
            font-size: 1.5em;
            color: #4a9eff;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .csv-export-btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.6em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: normal;
        }

        .csv-export-btn:hover {
            background: #6bb0ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 158, 255, 0.3);
        }

        .csv-export-btn:active {
            transform: translateY(0);
        }

        .date-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #252525;
            border-radius: 10px;
            border-left: 4px solid #4a9eff;
        }

        .date-info .main-date {
            font-size: 1.3em;
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .date-info .sub-date {
            font-size: 1.05em;
            color: #b0b0b0;
        }

        .daily-target {
            margin-top: 12px;
            padding: 10px;
            background: rgba(234, 179, 8, 0.1);
            border-radius: 8px;
            border-left: 3px solid #eab308;
        }

        .daily-target-label {
            font-size: 0.85em;
            color: #b0b0b0;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .daily-target-value {
            font-size: 1.1em;
            color: #fbbf24;
            font-weight: bold;
        }

        .daily-target-110 {
            margin-top: 8px;
            padding: 10px;
            background: rgba(249, 115, 22, 0.1);
            border-radius: 8px;
            border-left: 3px solid #f97316;
        }

        .daily-target-110-label {
            font-size: 0.85em;
            color: #b0b0b0;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .daily-target-110-value {
            font-size: 1.1em;
            color: #fb923c;
            font-weight: bold;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .summary-table th {
            background: #252525;
            color: #b0b0b0;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #3d3d3d;
            font-size: 0.9em;
        }

        .summary-table td {
            padding: 8px;
            text-align: right;
            border: 1px solid #3d3d3d;
            color: #e0e0e0;
        }

        .summary-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #b0b0b0;
        }

        .summary-table tbody tr:hover {
            background: #353535;
        }

        .summary-table .total-row {
            background: #252525;
            font-weight: bold;
            border-top: 2px solid #4a9eff;
        }

        .summary-table .total-row td {
            color: #e0e0e0;
        }

        .summary-table .positive-value {
            color: #34d399;
            font-weight: 600;
        }

        .summary-table .negative-value {
            color: #f87171;
            font-weight: 600;
        }

        .summary-table .neutral-value {
            color: #e0e0e0;
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container {
            margin-top: 8px;
            width: 100%;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #3d3d3d;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.6s ease, background 0.3s ease;
            position: relative;
        }

        .progress-bar.positive {
            background: linear-gradient(90deg, #34d399, #10b981);
        }

        .progress-bar.negative {
            background: linear-gradient(90deg, #f87171, #ef4444);
        }

        .progress-text {
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }

        /* å€åŸŸé¸æ“‡å™¨æ¨£å¼ */
        .region-selector {
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #3d3d3d;
        }

        .region-title {
            font-size: 1.1em;
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .region-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .region-btn {
            background: #3d3d3d;
            color: #e0e0e0;
            border: 2px solid #4a4a4a;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .region-btn:hover {
            background: #4a4a4a;
            border-color: #4a9eff;
            transform: translateY(-2px);
        }

        .region-btn.active {
            background: #4a9eff;
            color: white;
            border-color: #4a9eff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #dc2626;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: #888;
            font-size: 0.9em;
        }

        /* æµ®å‹•è¦–çª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }

        .modal-content {
            background-color: #2d2d2d;
            margin: 1% auto;
            padding: 15px;
            border: 1px solid #4a4a4a;
            border-radius: 15px;
            width: 42%;
            max-width: 550px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            -webkit-overflow-scrolling: touch;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #4a9eff;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #6bb0ff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #4a9eff;
            padding-bottom: 8px;
        }

        .modal-title {
            font-size: 1.3em;
            color: #4a9eff;
            font-weight: bold;
        }

        .close {
            color: #888;
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
        }

        .close:hover {
            color: #e0e0e0;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            font-size: 0.78em;
        }

        .detail-table th {
            background: #252525;
            color: #b0b0b0;
            padding: 6px 4px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #3d3d3d;
            font-size: 0.9em;
        }

        .detail-table td {
            padding: 4px 5px;
            text-align: right;
            border: 1px solid #3d3d3d;
            color: #e0e0e0;
            line-height: 1.3;
        }

        .detail-table td:first-child,
        .detail-table td:nth-child(2) {
            text-align: center;
        }

        .holiday {
            color: #f87171 !important;
        }

        .detail-table tbody tr:hover {
            background: #353535;
        }

        .detail-table .total-row {
            background: #252525;
            font-weight: bold;
            border-top: 2px solid #4a9eff;
        }

        .clickable-store {
            cursor: pointer;
            transition: color 0.3s;
        }

        .clickable-store:hover {
            color: #4a9eff;
            text-decoration: underline;
        }

        /* å¹³æ¿æ¨£å¼ (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .container {
                padding: 15px;
            }

            #headerSubtitle {
                font-size: 1em !important;
            }

            .dashboard {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .summary-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .summary-table {
                min-width: 1000px;
            }

            .region-selector {
                flex-wrap: wrap;
                gap: 8px;
            }

            .region-btn {
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .modal-content {
                width: 70%;
                max-width: 600px;
            }
        }

        /* æ‰‹æ©Ÿæ¨£å¼ (æœ€å¤§ 768px) */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 15px 10px;
            }

            .dashboard {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            h1 {
                font-size: 1.5em;
                padding: 15px;
            }

            #headerSubtitle {
                font-size: 0.95em !important;
                margin-top: 5px !important;
            }

            /* å€åŸŸé¸æ“‡å™¨ */
            .region-selector {
                flex-wrap: wrap;
                gap: 6px;
                padding: 10px;
            }

            .region-btn {
                padding: 8px 12px;
                font-size: 0.85em;
                flex: 1 1 calc(33.333% - 6px);
                min-width: 80px;
            }

            /* å¡ç‰‡æ¨£å¼ */
            .card {
                padding: 15px;
            }

            .store-name {
                font-size: 1.3em;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            .metric-row {
                grid-template-columns: 100px 1fr;
                gap: 8px;
            }
            
            .metric-label {
                font-size: 0.8em;
            }
            
            .metric-value {
                font-size: 0.95em;
            }
            
            .percentage {
                font-size: 0.65em;
                padding: 2px 6px;
            }

            .amount {
                font-size: 0.7em;
            }

            .daily-target {
                padding: 8px;
                margin-top: 8px;
            }

            .daily-target-label,
            .daily-target-100-label,
            .daily-target-110-label {
                font-size: 0.75em;
            }

            .daily-target-value,
            .daily-target-100-value,
            .daily-target-110-value {
                font-size: 0.9em;
            }

            /* è¡¨æ ¼æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
            .summary-table-container {
                padding: 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .summary-table-title {
                font-size: 1.1em;
                padding: 10px;
            }

            .csv-export-btn {
                padding: 6px 12px;
                font-size: 0.7em;
            }

            .date-info {
                padding: 8px;
                font-size: 0.85em;
            }

            .date-info .main-date {
                font-size: 0.9em;
            }

            .date-info .sub-date {
                font-size: 0.75em;
            }

            /* è¡¨æ ¼å¯æ©«å‘æ»¾å‹• */
            .summary-table {
                font-size: 0.7em;
                min-width: 1000px;
                display: table;
            }

            .summary-table th,
            .summary-table td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            .scroll-hint {
                display: block;
                font-size: 0.8em;
                color: #4a9eff;
            }

            /* æµ®å‹•è¦–çª—æ‰‹æ©Ÿç‰ˆ */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 2% auto;
                padding: 12px;
                max-height: 90vh;
            }

            .modal-title {
                font-size: 1.1em;
            }

            .detail-table {
                font-size: 0.7em;
            }

            .detail-table th {
                padding: 5px 3px;
            }

            .detail-table td {
                padding: 4px 3px;
            }

            .close {
                font-size: 1.5em;
            }

            /* ä¸Šå‚³å€åŸŸ */
            .upload-area {
                padding: 30px 15px;
            }

            .upload-icon {
                font-size: 2.5em;
            }

            .upload-text {
                font-size: 0.9em;
            }

            .upload-hint {
                font-size: 0.75em;
            }
        }

        /* å°æ‰‹æ©Ÿæ¨£å¼ (æœ€å¤§ 480px) */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.3em;
                padding: 12px;
            }

            #headerSubtitle {
                font-size: 0.85em !important;
            }

            .region-btn {
                flex: 1 1 calc(50% - 6px);
                font-size: 0.8em;
                padding: 6px 10px;
            }

            .card {
                padding: 12px;
            }

            .store-name {
                font-size: 1.2em;
            }

            .summary-table {
                font-size: 0.65em;
                min-width: 950px;
            }

            .summary-table th,
            .summary-table td {
                padding: 5px 3px;
            }

            .csv-export-btn {
                padding: 5px 10px;
                font-size: 0.65em;
            }

            .modal-content {
                width: 98%;
                padding: 10px;
            }

            .modal-title {
                font-size: 1em;
            }

            .detail-table {
                font-size: 0.65em;
            }

            .scroll-hint {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ç«‹å±•æ¥­ç¸¾å ±è¡¨åˆ†æç³»çµ±</h1>
            <p id="headerSubtitle" style="color: #b0b0b0; font-size: 1.1em; margin-top: 10px;">ä¸Šå‚³æ¯æ—¥æ¥­ç¸¾å ±è¡¨ï¼Œå³æ™‚æŸ¥çœ‹å„åº—è¡¨ç¾</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ›³Excelæª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</div>
                <div style="color: #999; margin-top: 10px;">æ”¯æ´æ ¼å¼ï¼š.xlsx, .xls</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <button class="btn" onclick="document.getElementById('fileInput').click()">é¸æ“‡æª”æ¡ˆ</button>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- å€åŸŸé¸æ“‡å™¨ -->
        <div class="region-selector" id="regionSelector">
            <div class="region-title">é¸æ“‡å€åŸŸ</div>
            <div class="region-buttons">
                <button class="region-btn active" data-region="å…¨ç¤¾">å…¨ç¤¾</button>
                <button class="region-btn" data-region="åŒ—ä¸€å€">åŒ—ä¸€å€</button>
                <button class="region-btn" data-region="åŒ—äºŒå€">åŒ—äºŒå€</button>
                <button class="region-btn" data-region="ä¸­å€">ä¸­å€</button>
                <button class="region-btn" data-region="å°å—å€">å°å—å€</button>
                <button class="region-btn" data-region="é«˜é›„å€">é«˜é›„å€</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div style="color: #4a9eff; font-size: 1.2em;">æ­£åœ¨åˆ†æè³‡æ–™...</div>
        </div>

        <div class="summary-table-container" id="summaryTable">
            <div class="summary-table-title">
                <span>ğŸ“Š æ¥­ç¸¾ç¸½è¦½</span>
                <button class="csv-export-btn" onclick="exportToCSV()">ğŸ“¥ è¼¸å‡ºCSV</button>
            </div>
            <div class="date-info" id="dateInfo">
                <!-- æ—¥æœŸè³‡è¨Šå°‡ç”±JavaScriptç”Ÿæˆ -->
            </div>
            <table class="summary-table" id="summaryTableContent">
                <!-- è¡¨æ ¼å…§å®¹å°‡ç”±JavaScriptç”Ÿæˆ -->
            </table>
            <div class="scroll-hint">â† å·¦å³æ»‘å‹•æŸ¥çœ‹æ›´å¤šè³‡è¨Š â†’</div>
        </div>

        <div class="dashboard" id="dashboard"></div>
    </div>

    <!-- æµ®å‹•è¦–çª— -->
    <div id="storeDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">åº—å®¶è©³ç´°è³‡æ–™</div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- è¡¨æ ¼å…§å®¹å°‡ç”±JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const dashboard = document.getElementById('dashboard');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const regionSelector = document.getElementById('regionSelector');

        // å…¨å±€è®Šæ•¸å­˜å„²è™•ç†å¾Œçš„æ•¸æ“š
        let allStoresData = [];
        let currentRegion = 'å…¨ç¤¾';
        let currentDisplayResults = []; // å­˜å„²ç•¶å‰é¡¯ç¤ºçš„åº—å®¶çµæœï¼Œä¾› modal ä½¿ç”¨

        // åº—å®¶é…ç½®ï¼šåº—å -> é¡¯ç¤ºåç¨±ï¼ˆä»£è™Ÿï¼‰
        const storeConfig = {
            'NK[i]store': '45',
            'SYA11[i]store': '51',
            'TY[i]store': '65',
            'TC[i]store': '75',
            'ä¸­å‹[i]store': '76',
            'è¥¿é–€[i]store': '86',
            'ä¸­å±±[i]store': '88',
            'ZU[i]store': '115',
            'è€æ–¯[i]store': '81',
            'ä¸‰å¤š[i]store': '116',
            'A4[i]store': '57',
            'TM[i]store': '47',
            'MS[i]store': '48',
            'å‚æ¥Š[i]store': '84',
            'SP[i]store': '117',
            'QP[i]store': '61',
            'MTN[i]store': '89',
            'MOPå°ä¸­[i]store': '77',
            'XBM[i]store': '97',
            'skm online': '820'
        };

        // å€åŸŸå®šç¾©
        const regionConfig = {
            'å…¨ç¤¾': ['45', '47', '48', '51', '57', '61', '65', '75', '76', '77', '81', '84', '86', '88', '89', '97', '115', '116', '117', '820'],
            'åŒ—ä¸€å€': ['45', '47', '48'],
            'åŒ—äºŒå€': ['51', '57', '61', '65'],
            'ä¸­å€': ['75', '76', '77', '81', '84'],
            'å°å—å€': ['86', '88', '89', '97'],
            'é«˜é›„å€': ['115', '116', '117']
        };

        // å€åŸŸåˆ‡æ›åŠŸèƒ½
        document.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰active
                document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
                // æ·»åŠ activeåˆ°ç•¶å‰æŒ‰éˆ•
                this.classList.add('active');
                // æ›´æ–°ç•¶å‰å€åŸŸ
                currentRegion = this.dataset.region;
                // é‡æ–°é¡¯ç¤ºæ•¸æ“š
                if (allStoresData.length > 0) {
                    displayResults(allStoresData);
                }
            });
        });

        // è²¡å¹´è¨ˆç®—å‡½æ•¸
        function calculateFiscalInfo() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // è²¡å¹´å¾æ¯å¹´9æœˆ28æ—¥é–‹å§‹
            const currentYear = today.getFullYear();
            const fyStartMonth = 8; // 9æœˆ (0-indexed)
            const fyStartDay = 28;
            
            // åˆ¤æ–·ç•¶å‰æ—¥æœŸæ‰€å±¬çš„è²¡å¹´
            let fiscalYear;
            let fyStartDate;
            
            if (today.getMonth() > fyStartMonth || (today.getMonth() === fyStartMonth && today.getDate() >= fyStartDay)) {
                // åœ¨9/28ä¹‹å¾Œï¼Œå±¬æ–¼ä¸‹ä¸€è²¡å¹´
                fiscalYear = currentYear + 1;
                fyStartDate = new Date(currentYear, fyStartMonth, fyStartDay);
            } else {
                // åœ¨9/28ä¹‹å‰ï¼Œå±¬æ–¼ç•¶å‰è²¡å¹´
                fiscalYear = currentYear;
                fyStartDate = new Date(currentYear - 1, fyStartMonth, fyStartDay);
            }
            
            // è¨ˆç®—å¾è²¡å¹´é–‹å§‹åˆ°ä»Šå¤©çš„å¤©æ•¸
            const daysSinceFYStart = Math.floor((today - fyStartDate) / (1000 * 60 * 60 * 24));
            
            // è¨ˆç®—å­£åº¦ (æ¯å­£13é€± = 91å¤©)
            const quarter = Math.floor(daysSinceFYStart / 91) + 1;
            
            // è¨ˆç®—å­£åº¦å…§çš„é€±æ•¸
            const daysInQuarter = daysSinceFYStart % 91;
            const weekInQuarter = Math.floor(daysInQuarter / 7) + 1;
            
            // è¨ˆç®—æœ¬æœˆå‰©é¤˜å¤©æ•¸ï¼ˆåŒ…å«ä»Šæ—¥ï¼‰
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const remainingDays = lastDayOfMonth.getDate() - today.getDate() + 1;
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const formatDate = (date) => {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}/${day}`;
            };
            
            return {
                fiscalYear: String(fiscalYear).slice(-2), // FY26 -> 26
                quarter: quarter,
                week: weekInQuarter,
                today: formatDate(today),  // ä»Šæ—¥
                yesterday: formatDate(yesterday),  // æ˜¨æ—¥
                remainingDays: remainingDays,
                currentMonth: today.getMonth() + 1
            };
        }

        // æ‹–æ”¾åŠŸèƒ½
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('è«‹ä¸Šå‚³æœ‰æ•ˆçš„Excelæª”æ¡ˆï¼ˆ.xlsx æˆ– .xlsï¼‰');
                return;
            }

            loading.style.display = 'block';
            dashboard.style.display = 'none';
            errorMessage.style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processData(jsonData);
                } catch (error) {
                    showError('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                    loading.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            try {
                // ========== æ­¥é©Ÿ1ï¼šå‹•æ…‹æŸ¥æ‰¾é—œéµè¡Œçš„ä½ç½® ==========
                const keyRows = {};
                for (let i = 0; i < data.length; i++) {
                    const label = data[i][0];
                    if (label === 'åˆè¨ˆ') keyRows.total = i;
                    else if (label === 'æœ¬æœˆç›®æ¨™') keyRows.target = i;
                    else if (label === 'å¯¦éš›æ¯›åˆ©ç‡(å«éŠ·è£œ)') keyRows.marginRate = i;
                    else if (label === 'å¯¦éš›æ¯›åˆ©é¡(å«éŠ·è£œ)') keyRows.marginAmount = i;
                    else if (label === 'é ä¼°æ¯›åˆ©é¡') keyRows.marginTarget = i;
                    else if (label === 'é ä¼°æ¯›åˆ©ç‡') keyRows.estimatedMarginRate = i;
                }
                
                // é©—è­‰æ˜¯å¦æ‰¾åˆ°é—œéµè¡Œ
                if (!keyRows.total || !keyRows.target) {
                    throw new Error('ç„¡æ³•æ‰¾åˆ°é—œéµè³‡æ–™è¡Œã€‚è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
                }
                
                console.log('æ‰¾åˆ°çš„é—œéµè¡Œä½ç½®ï¼š', keyRows);
                
                // ========== æ­¥é©Ÿ2ï¼šå‹•æ…‹æœç´¢åº—åå’Œåˆ—ä½ç½® ==========
                const storeColumns = {};
                const storeNames = Object.keys(storeConfig);
                
                // åœ¨å‰5è¡Œä¸­æœç´¢åº—å
                for (let rowIdx = 0; rowIdx < 5; rowIdx++) {
                    for (let colIdx = 0; colIdx < data[rowIdx].length; colIdx++) {
                        const cell = data[rowIdx][colIdx];
                        if (cell && storeNames.includes(cell)) {
                            const displayName = storeConfig[cell];
                            
                            // æ‰¾åˆ°åº—åå¾Œï¼Œå¾€å³æ‰¾"åˆè¨ˆ"åˆ—
                            let totalCol = colIdx + 2;  // é è¨­åœ¨+2ä½ç½®
                            
                            // é©—è­‰æ˜¯å¦ç‚ºåˆè¨ˆåˆ—
                            if (rowIdx + 1 < data.length) {
                                for (let c = colIdx; c < Math.min(colIdx + 5, data[rowIdx + 1].length); c++) {
                                    if (data[rowIdx + 1][c] === 'åˆè¨ˆ') {
                                        totalCol = c;
                                        break;
                                    }
                                }
                            }
                            
                            // å‘å‰æœç´¢æ‰¾åˆ°å°æ‡‰çš„"è‡ªç‡Ÿ"å’Œ"å°ˆæ«ƒ"åˆ—ï¼ˆåœ¨ç¬¬2è¡Œï¼Œå³rowIdx+1ï¼‰
                            let selfCol = totalCol;
                            let counterCol = totalCol;
                            
                            // å¾åˆè¨ˆåˆ—å‘å‰æœç´¢ï¼ˆæœ€å¤šæœç´¢10åˆ—ï¼‰
                            for (let c = totalCol - 1; c >= Math.max(totalCol - 10, colIdx); c--) {
                                if (data[rowIdx + 1][c] === 'å°ˆæ«ƒ') {
                                    counterCol = c;
                                }
                                if (data[rowIdx + 1][c] === 'è‡ªç‡Ÿ') {
                                    selfCol = c;
                                    break; // æ‰¾åˆ°è‡ªç‡Ÿå°±åœæ­¢ï¼Œå› ç‚ºè‡ªç‡Ÿåœ¨æœ€å‰é¢
                                }
                            }
                            
                            // åœ¨åˆè¨ˆåˆ—é™„è¿‘æœç´¢æ¯›åˆ©è³‡æ–™ï¼ˆå¯èƒ½åœ¨åˆè¨ˆåˆ—æœ¬èº«ï¼Œæˆ–å³å´1-2åˆ—ï¼‰
                            let marginCol = totalCol;
                            let foundMargin = false;
                            
                            if (keyRows.marginAmount) {
                                // å…ˆæª¢æŸ¥åˆè¨ˆåˆ—æœ¬èº«
                                const totalColMargin = parseFloat(data[keyRows.marginAmount][totalCol]);
                                if (!isNaN(totalColMargin) && Math.abs(totalColMargin) > 10) {
                                    marginCol = totalCol;
                                    foundMargin = true;
                                } else {
                                    // åœ¨åˆè¨ˆåˆ—å³å´1-3åˆ—ä¸­æœç´¢
                                    for (let c = totalCol + 1; c < Math.min(totalCol + 4, data[keyRows.marginAmount].length); c++) {
                                        const val = parseFloat(data[keyRows.marginAmount][c]);
                                        if (!isNaN(val) && Math.abs(val) > 10) {
                                            marginCol = c;
                                            foundMargin = true;
                                            break;
                                        }
                                    }
                                    
                                    // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå¾€å·¦å´æœç´¢ï¼ˆé‡å°æŸäº›ç‰¹æ®Šæ ¼å¼ï¼‰
                                    if (!foundMargin) {
                                        for (let c = colIdx; c < totalCol; c++) {
                                            const val = parseFloat(data[keyRows.marginAmount][c]);
                                            if (!isNaN(val) && Math.abs(val) > 10) {
                                                marginCol = c;
                                                foundMargin = true;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            storeColumns[displayName] = { 
                                col: totalCol, 
                                marginCol: marginCol,
                                selfCol: selfCol,
                                counterCol: counterCol
                            };
                            
                            console.log(`${displayName}: æ¥­ç¸¾åˆ—=${totalCol}, æ¯›åˆ©åˆ—=${marginCol}, è‡ªç‡Ÿåˆ—=${selfCol}, å°ˆæ«ƒåˆ—=${counterCol}, æ‰¾åˆ°æ¯›åˆ©=${foundMargin}`);
                        }
                    }
                }
                
                console.log('æ‰¾åˆ°çš„åº—å®¶åˆ—ä½ç½®ï¼š', storeColumns);
                
                // ========== æ­¥é©Ÿ3ï¼šæå–æ¯å®¶åº—çš„æ•¸æ“š ==========
                const results = [];
                const allStoreNames = Object.values(storeConfig);
                
                allStoreNames.forEach(storeName => {
                    if (!storeColumns[storeName]) {
                        console.warn(`æœªæ‰¾åˆ°åº—å®¶ï¼š${storeName}`);
                        return;
                    }
                    
                    const { col, marginCol, selfCol, counterCol } = storeColumns[storeName];
                    
                    // æå–æ¯æ—¥è©³ç´°æ•¸æ“šï¼ˆå¾ç¬¬3è¡Œåˆ°åˆè¨ˆè¡Œçš„å‰ä¸€è¡Œï¼‰
                    const dailyData = [];
                    const lastDayRow = keyRows.total - 1; // åˆè¨ˆè¡Œçš„å‰ä¸€è¡Œæ˜¯æœ€å¾Œä¸€å¤©
                    for (let dayRow = 3; dayRow <= lastDayRow; dayRow++) {
                        const date = data[dayRow][0];
                        const weekday = data[dayRow][1];
                        const selfSales = parseFloat(data[dayRow][selfCol]) || 0;  // è‡ªç‡Ÿ
                        const counterSales = parseFloat(data[dayRow][counterCol]) || 0;  // å°ˆæ«ƒ
                        const totalSales = parseFloat(data[dayRow][col]) || 0;  // åˆè¨ˆ
                        
                        dailyData.push({
                            date: date,
                            weekday: weekday,
                            selfSales: selfSales,
                            counterSales: counterSales,
                            totalSales: totalSales
                        });
                    }
                    
                    // æå–æœ¬æœˆç›®æ¨™çš„è‡ªç‡Ÿå’Œå°ˆæ«ƒæ•¸æ“šï¼ˆä½¿ç”¨å‹•æ…‹æ‰¾åˆ°çš„è¡Œï¼‰
                    const targetSelf = parseFloat(data[keyRows.target][selfCol]) || 0;
                    const targetCounter = parseFloat(data[keyRows.target][counterCol]) || 0;
                    
                    // æå–æ•¸æ“š
                    const currentPerformance = parseFloat(data[keyRows.total][col]) || 0;
                    const targetPerformance = parseFloat(data[keyRows.target][col]) || 0;
                    const grossMarginTarget = keyRows.marginTarget ? (parseFloat(data[keyRows.marginTarget][marginCol]) || 0) : 0;
                    const grossMarginRate = keyRows.marginRate ? (parseFloat(data[keyRows.marginRate][marginCol]) || 0) : 0;
                    const grossMarginAmount = keyRows.marginAmount ? (parseFloat(data[keyRows.marginAmount][marginCol]) || 0) : 0;
                    const estimatedMarginRate = keyRows.estimatedMarginRate ? (parseFloat(data[keyRows.estimatedMarginRate][marginCol]) || 0) : 0;
                    const actualMarginRate = grossMarginRate; // å¯¦éš›æ¯›åˆ©ç‡(å«éŠ·è£œ)

                    // è¨ˆç®—é”æˆç‡å’Œå·®ç•°
                    const performanceRate = targetPerformance > 0 ? (currentPerformance / targetPerformance) * 100 : 0;
                    const performanceDiff = currentPerformance - targetPerformance;
                    const marginRate = grossMarginTarget > 0 ? (grossMarginAmount / grossMarginTarget) * 100 : 0;
                    const marginDiff = grossMarginAmount - grossMarginTarget;
                    const marginRateDiff = actualMarginRate - estimatedMarginRate; // æ¯›åˆ©ç‡å·®ç•°
                    
                    // æå–å»å¹´åŒæœŸæ•¸æ“šï¼ˆè‡ªç‡Ÿã€å°ˆæ«ƒã€åˆè¨ˆï¼‰
                    // å»å¹´æœ¬æœˆå¯¦ç¸¾åœ¨åˆè¨ˆè¡Œ + 3ï¼Œæˆé•·ç‡åœ¨åˆè¨ˆè¡Œ + 4
                    const lastYearRow = keyRows.total + 3;
                    const growthRateRow = keyRows.total + 4;
                    
                    const lastYearSelf = parseFloat(data[lastYearRow][selfCol]) || 0;
                    const lastYearCounter = parseFloat(data[lastYearRow][counterCol]) || 0;
                    const lastYearPerformance = parseFloat(data[lastYearRow][col]) || 0;
                    
                    // æå–æˆé•·ç‡æ•¸æ“šï¼ˆè‡ªç‡Ÿã€å°ˆæ«ƒã€åˆè¨ˆï¼‰
                    const growthRateSelf = parseFloat(data[growthRateRow][selfCol]) || 0;
                    const growthRateCounter = parseFloat(data[growthRateRow][counterCol]) || 0;
                    const growthRate = parseFloat(data[growthRateRow][col]) || 0;

                    results.push({
                        name: storeName,
                        currentPerformance,
                        targetPerformance,
                        performanceRate,
                        performanceDiff,
                        grossMarginAmount,
                        grossMarginTarget,
                        marginRate,
                        marginDiff,
                        grossMarginRate: grossMarginRate * 100,
                        estimatedMarginRate: estimatedMarginRate * 100,
                        actualMarginRate: actualMarginRate * 100,
                        marginRateDiff: marginRateDiff * 100,
                        dailyData: dailyData,
                        lastYearSelf: lastYearSelf,
                        lastYearCounter: lastYearCounter,
                        lastYearPerformance: lastYearPerformance,
                        growthRateSelf: growthRateSelf * 100,
                        growthRateCounter: growthRateCounter * 100,
                        growthRate: growthRate * 100,
                        targetSelf: targetSelf,
                        targetCounter: targetCounter
                    });
                    
                    console.log(`${storeName}æ•¸æ“šï¼š`, {
                        æ¥­ç¸¾: currentPerformance,
                        ç›®æ¨™: targetPerformance,
                        æ¯›åˆ©é¡: grossMarginAmount
                    });
                });

                // å­˜å„²æ‰€æœ‰åº—å®¶æ•¸æ“š
                allStoresData = results;
                
                displayResults(results);
            } catch (error) {
                console.error('è™•ç†éŒ¯èª¤ï¼š', error);
                showError('è³‡æ–™è™•ç†å¤±æ•—ï¼š' + error.message);
                loading.style.display = 'none';
            }
        }

        function displayResults(allResults) {
            dashboard.innerHTML = '';
            
            // æ ¹æ“šç•¶å‰å€åŸŸéæ¿¾åº—å®¶ä¸¦æŒ‰é †åºæ’åˆ—
            const regionStores = regionConfig[currentRegion];
            const results = regionStores
                .map(storeName => allResults.find(store => store.name === storeName))
                .filter(store => store !== undefined);
            
            // ä¿å­˜ç•¶å‰é¡¯ç¤ºçš„çµæœä¾› modal ä½¿ç”¨
            currentDisplayResults = results;
            
            // è¨ˆç®—è²¡å¹´ä¿¡æ¯
            const fiscalInfo = calculateFiscalInfo();
            
            // ç‚ºæ¯å€‹åº—å®¶è¨ˆç®—æ¯æ—¥ç›®æ¨™ï¼ˆ100%å’Œ110%ï¼‰
            results.forEach(store => {
                let dailyTarget100 = 0;
                let dailyTarget110 = 0;
                
                if (store.grossMarginTarget > 0 && store.grossMarginRate > 0 && fiscalInfo.remainingDays > 0) {
                    // 100% ç›®æ¨™è¨ˆç®—
                    const performanceGap100 = store.targetPerformance - store.currentPerformance;
                    const dailyTargetByPerformance100 = (performanceGap100 / fiscalInfo.remainingDays) * 1.05;
                    
                    const marginGap100 = store.grossMarginTarget - store.grossMarginAmount;
                    const dailyTargetByMargin100 = (marginGap100 / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                    
                    dailyTarget100 = Math.max(dailyTargetByPerformance100, dailyTargetByMargin100);
                    
                    // 110% ç›®æ¨™è¨ˆç®—
                    const performanceGap110 = (store.targetPerformance * 1.1) - store.currentPerformance;
                    const dailyTargetByPerformance110 = (performanceGap110 / fiscalInfo.remainingDays) * 1.05;
                    
                    const marginGap110 = (store.grossMarginTarget * 1.1) - store.grossMarginAmount;
                    const dailyTargetByMargin110 = (marginGap110 / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                    
                    dailyTarget110 = Math.max(dailyTargetByPerformance110, dailyTargetByMargin110);
                }
                
                store.dailyTarget100 = dailyTarget100;
                store.dailyTarget110 = dailyTarget110;
            });
            
            // è¨ˆç®—ç¸½å’Œ
            const totals = {
                name: currentRegion,
                currentPerformance: 0,
                targetPerformance: 0,
                grossMarginAmount: 0,
                grossMarginTarget: 0,
                performanceRate: 0,
                performanceDiff: 0,
                marginRate: 0,
                marginDiff: 0,
                grossMarginRate: 0,
                estimatedMarginRate: 0,
                actualMarginRate: 0,
                marginRateDiff: 0,
                dailyTarget100: 0,
                dailyTarget110: 0
            };
            
            results.forEach(store => {
                totals.currentPerformance += store.currentPerformance;
                totals.targetPerformance += store.targetPerformance;
                totals.grossMarginAmount += store.grossMarginAmount;
                totals.grossMarginTarget += store.grossMarginTarget;
                totals.dailyTarget100 += store.dailyTarget100;
                totals.dailyTarget110 += store.dailyTarget110;
            });
            
            totals.performanceDiff = totals.currentPerformance - totals.targetPerformance;
            totals.performanceRate = totals.targetPerformance > 0 ? (totals.currentPerformance / totals.targetPerformance) * 100 : 0;
            totals.marginDiff = totals.grossMarginAmount - totals.grossMarginTarget;
            totals.marginRate = totals.grossMarginTarget > 0 ? (totals.grossMarginAmount / totals.grossMarginTarget) * 100 : 0;
            totals.grossMarginRate = totals.currentPerformance > 0 ? (totals.grossMarginAmount / totals.currentPerformance) * 100 : 0;
            
            // è¨ˆç®—é ä¼°æ¯›åˆ©ç‡ï¼ˆåŠ æ¬Šå¹³å‡ï¼‰
            let totalEstimatedMargin = 0;
            let totalActualMargin = 0;
            results.forEach(store => {
                if (store.estimatedMarginRate !== 0 && store.currentPerformance > 0) {
                    totalEstimatedMargin += (store.estimatedMarginRate / 100) * store.currentPerformance;
                }
                if (store.actualMarginRate !== 0 && store.currentPerformance > 0) {
                    totalActualMargin += (store.actualMarginRate / 100) * store.currentPerformance;
                }
            });
            totals.estimatedMarginRate = totals.currentPerformance > 0 ? (totalEstimatedMargin / totals.currentPerformance) * 100 : 0;
            totals.actualMarginRate = totals.currentPerformance > 0 ? (totalActualMargin / totals.currentPerformance) * 100 : 0;
            totals.marginRateDiff = totals.actualMarginRate - totals.estimatedMarginRate;
            
            // é¡¯ç¤ºæ—¥æœŸä¿¡æ¯
            displayDateInfo(fiscalInfo);
            
            // ç”Ÿæˆè¡¨æ ¼
            generateSummaryTable(results, totals);
            
            // å…ˆé¡¯ç¤ºç¸½å’Œå¡ç‰‡
            createStoreCard(totals, true, fiscalInfo);
            
            // å†é¡¯ç¤ºå„åº—å¡ç‰‡
            results.forEach(store => {
                createStoreCard(store, false, fiscalInfo);
            });

            loading.style.display = 'none';
            document.getElementById('summaryTable').style.display = 'block';
            dashboard.style.display = 'grid';
        }

        function displayDateInfo(fiscalInfo) {
            const dateInfoDiv = document.getElementById('dateInfo');
            dateInfoDiv.innerHTML = `
                <div class="main-date">
                    ğŸ“… FY${fiscalInfo.fiscalYear}Q${fiscalInfo.quarter}W${fiscalInfo.week} ${fiscalInfo.today}
                </div>
                <div class="sub-date">
                    ç´¯è¨ˆè‡³æ˜¨æ—¥ ${fiscalInfo.yesterday}ã€€æœ¬æœˆå‰©é¤˜å¤©æ•¸ï¼š${fiscalInfo.remainingDays} å¤©
                </div>
            `;
        }

        function generateSummaryTable(results, totals) {
            const tableContent = document.getElementById('summaryTableContent');
            
            let html = `
                <thead>
                    <tr>
                        <th>åº—å®¶</th>
                        <th>ç›®æ¨™æ¥­ç¸¾</th>
                        <th>ç›®å‰æ¥­ç¸¾</th>
                        <th>é”æˆç‡</th>
                        <th>æ¥­ç¸¾å·®ç•°</th>
                        <th>æ¯›åˆ©é¡ç›®æ¨™</th>
                        <th>ç›®å‰æ¯›åˆ©é¡</th>
                        <th>æ¯›åˆ©é¡é”æˆç‡</th>
                        <th>æ¯›åˆ©é¡å·®ç•°</th>
                        <th>é ä¼°æ¯›åˆ©ç‡</th>
                        <th>å¯¦éš›æ¯›åˆ©ç‡</th>
                        <th>æ¯›åˆ©ç‡å·®ç•°</th>
                        <th>100%å«ç¨…æ¯æ—¥</th>
                        <th>110%å«ç¨…æ¯æ—¥</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // å„åº—è³‡æ–™
            results.forEach((store, index) => {
                const perfDiffClass = store.performanceDiff >= 0 ? 'positive-value' : 'negative-value';
                const perfRateClass = store.performanceRate >= 100 ? 'positive-value' : 'negative-value';
                const marginDiffClass = store.marginDiff >= 0 ? 'positive-value' : 'negative-value';
                const marginRateClass = store.marginRate >= 100 ? 'positive-value' : 'negative-value';
                
                // åˆ¤æ–·æ˜¯å¦éœ€è¦åŠ ç¬¦è™Ÿ
                let storeNameDisplay = store.name;
                if (store.performanceRate >= 110 && store.marginRate >= 110) {
                    // æ¥­ç¸¾é”æˆç‡å’Œæ¯›åˆ©é¡é”æˆç‡éƒ½>=110%ï¼šé‘½çŸ³
                    storeNameDisplay = `${store.name} ğŸ’`;
                } else if (store.performanceRate >= 100 && store.marginRate >= 100) {
                    // æ¥­ç¸¾é”æˆç‡å’Œæ¯›åˆ©é¡é”æˆç‡éƒ½>=100%ï¼šçš‡å† 
                    storeNameDisplay = `${store.name} ğŸ‘‘`;
                }
                
                html += `
                    <tr>
                        <td><span class="clickable-store" onclick="showStoreDetail(${index})">${storeNameDisplay}</span></td>
                        <td class="neutral-value">${formatNumber(store.targetPerformance)}</td>
                        <td class="neutral-value">${formatNumber(store.currentPerformance)}</td>
                        <td class="${perfRateClass}">${store.performanceRate.toFixed(1)}%</td>
                        <td class="${perfDiffClass}">${store.performanceDiff >= 0 ? '+' : ''}${formatNumber(store.performanceDiff)}</td>
                        <td class="neutral-value">${store.grossMarginTarget > 0 ? formatNumber(store.grossMarginTarget) : '-'}</td>
                        <td class="${store.grossMarginAmount !== 0 ? (store.grossMarginAmount >= 0 ? 'neutral-value' : 'negative-value') : 'neutral-value'}">${store.grossMarginAmount !== 0 ? formatNumber(store.grossMarginAmount) : '-'}</td>
                        <td class="${marginRateClass}">${store.grossMarginTarget > 0 ? store.marginRate.toFixed(1) + '%' : '-'}</td>
                        <td class="${marginDiffClass}">${store.grossMarginTarget > 0 ? (store.marginDiff >= 0 ? '+' : '') + formatNumber(store.marginDiff) : '-'}</td>
                        <td class="neutral-value">${store.estimatedMarginRate !== 0 ? store.estimatedMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td class="neutral-value">${store.actualMarginRate !== 0 ? store.actualMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td class="${store.marginRateDiff >= 0 ? 'positive-value' : 'negative-value'}">${store.marginRateDiff !== 0 ? (store.marginRateDiff >= 0 ? '+' : '') + store.marginRateDiff.toFixed(2) + '%' : '-'}</td>
                        <td class="neutral-value">${store.dailyTarget100 > 0 ? formatNumber(store.dailyTarget100) : '-'}</td>
                        <td class="neutral-value">${store.dailyTarget110 > 0 ? formatNumber(store.dailyTarget110) : '-'}</td>
                    </tr>
                `;
            });
            
            // ç¸½è¨ˆè¡Œ
            const totalPerfDiffClass = totals.performanceDiff >= 0 ? 'positive-value' : 'negative-value';
            const totalPerfRateClass = totals.performanceRate >= 100 ? 'positive-value' : 'negative-value';
            const totalMarginDiffClass = totals.marginDiff >= 0 ? 'positive-value' : 'negative-value';
            const totalMarginRateClass = totals.marginRate >= 100 ? 'positive-value' : 'negative-value';
            
            html += `
                    <tr class="total-row">
                        <td>${totals.name}ç¸½è¨ˆ</td>
                        <td>${formatNumber(totals.targetPerformance)}</td>
                        <td>${formatNumber(totals.currentPerformance)}</td>
                        <td class="${totalPerfRateClass}">${totals.performanceRate.toFixed(1)}%</td>
                        <td class="${totalPerfDiffClass}">${totals.performanceDiff >= 0 ? '+' : ''}${formatNumber(totals.performanceDiff)}</td>
                        <td>${formatNumber(totals.grossMarginTarget)}</td>
                        <td>${formatNumber(totals.grossMarginAmount)}</td>
                        <td class="${totalMarginRateClass}">${totals.marginRate.toFixed(1)}%</td>
                        <td class="${totalMarginDiffClass}">${totals.marginDiff >= 0 ? '+' : ''}${formatNumber(totals.marginDiff)}</td>
                        <td>${totals.estimatedMarginRate !== 0 ? totals.estimatedMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td>${totals.actualMarginRate !== 0 ? totals.actualMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td class="${totals.marginRateDiff >= 0 ? 'positive-value' : 'negative-value'}">${totals.marginRateDiff !== 0 ? (totals.marginRateDiff >= 0 ? '+' : '') + totals.marginRateDiff.toFixed(2) + '%' : '-'}</td>
                        <td>${totals.dailyTarget100 > 0 ? formatNumber(totals.dailyTarget100) : '-'}</td>
                        <td>${totals.dailyTarget110 > 0 ? formatNumber(totals.dailyTarget110) : '-'}</td>
                    </tr>
                </tbody>
            `;
            
            tableContent.innerHTML = html;
        }

        function createStoreCard(store, isTotal, fiscalInfo) {
                const card = document.createElement('div');
                card.className = isTotal ? 'store-card total-card' : 'store-card';
                
                const performanceClass = store.performanceRate >= 100 ? 'positive' : 'negative';
                const marginClass = store.marginRate >= 100 ? 'positive' : 'negative';
                
                // è¨ˆç®—æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾ï¼ˆæ”¾åœ¨æœ€ä¸‹æ–¹ï¼‰
                let dailyTargetHtml = '';
                if (!isTotal && store.grossMarginTarget > 0 && store.grossMarginRate > 0 && fiscalInfo.remainingDays > 0) {
                    const currentMarginRate = store.marginRate; // ç›®å‰æ¯›åˆ©é”æˆç‡
                    const currentPerformanceRate = store.performanceRate; // ç›®å‰æ¥­ç¸¾é”æˆç‡
                    
                    // å¦‚æœæ¥­ç¸¾æˆ–æ¯›åˆ©æœªé”åˆ° 100%ï¼ŒåŒæ™‚é¡¯ç¤º 100% å’Œ 110% ç›®æ¨™
                    if (currentMarginRate < 100 || currentPerformanceRate < 100) {
                        // 100% ç›®æ¨™è¨ˆç®—
                        // 1. ç‚ºé”åˆ°æ¥­ç¸¾100%ï¼Œæ¯æ—¥éœ€åšæ¥­ç¸¾ï¼ˆå«ç¨…ï¼‰
                        const performanceGap100 = store.targetPerformance - store.currentPerformance;
                        const dailyTargetByPerformance100 = (performanceGap100 / fiscalInfo.remainingDays) * 1.05;
                        
                        // 2. ç‚ºé”åˆ°æ¯›åˆ©é¡100%ï¼Œæ¯æ—¥éœ€åšæ¥­ç¸¾ï¼ˆå«ç¨…ï¼‰
                        const marginGap100 = store.grossMarginTarget - store.grossMarginAmount;
                        const dailyTargetByMargin100 = (marginGap100 / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                        
                        // å–å…©è€…è¼ƒå¤§å€¼
                        const dailyTarget100 = Math.max(dailyTargetByPerformance100, dailyTargetByMargin100);
                        
                        // 110% ç›®æ¨™è¨ˆç®—
                        // 1. ç‚ºé”åˆ°æ¥­ç¸¾110%ï¼Œæ¯æ—¥éœ€åšæ¥­ç¸¾ï¼ˆå«ç¨…ï¼‰
                        const performanceGap110 = (store.targetPerformance * 1.1) - store.currentPerformance;
                        const dailyTargetByPerformance110 = (performanceGap110 / fiscalInfo.remainingDays) * 1.05;
                        
                        // 2. ç‚ºé”åˆ°æ¯›åˆ©é¡110%ï¼Œæ¯æ—¥éœ€åšæ¥­ç¸¾ï¼ˆå«ç¨…ï¼‰
                        const marginGap110 = (store.grossMarginTarget * 1.1) - store.grossMarginAmount;
                        const dailyTargetByMargin110 = (marginGap110 / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                        
                        // å–å…©è€…è¼ƒå¤§å€¼
                        const dailyTarget110 = Math.max(dailyTargetByPerformance110, dailyTargetByMargin110);
                        
                        dailyTargetHtml = `
                            <div class="daily-target">
                                <div class="daily-target-label">æ¥­ç¸¾&æ¯›åˆ©ç›®æ¨™ 100% æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾</div>
                                <div class="daily-target-value">${formatNumber(dailyTarget100)}</div>
                            </div>
                            <div class="daily-target-110">
                                <div class="daily-target-110-label">æ¥­ç¸¾&æ¯›åˆ©ç›®æ¨™ 110% æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾</div>
                                <div class="daily-target-110-value">${formatNumber(dailyTarget110)}</div>
                            </div>
                        `;
                    }
                    // å¦‚æœæ¥­ç¸¾å’Œæ¯›åˆ©éƒ½é”åˆ° 100% ä½†æœ‰ä¸€å€‹æœªé”åˆ° 110%ï¼Œåªé¡¯ç¤º 110% ç›®æ¨™
                    else if (currentMarginRate < 110 || currentPerformanceRate < 110) {
                        // 1. ç‚ºé”åˆ°æ¥­ç¸¾110%ï¼Œæ¯æ—¥éœ€åšæ¥­ç¸¾ï¼ˆå«ç¨…ï¼‰
                        const performanceGap110 = (store.targetPerformance * 1.1) - store.currentPerformance;
                        const dailyTargetByPerformance110 = (performanceGap110 / fiscalInfo.remainingDays) * 1.05;
                        
                        // 2. ç‚ºé”åˆ°æ¯›åˆ©é¡110%ï¼Œæ¯æ—¥éœ€åšæ¥­ç¸¾ï¼ˆå«ç¨…ï¼‰
                        const marginGap110 = (store.grossMarginTarget * 1.1) - store.grossMarginAmount;
                        const dailyTargetByMargin110 = (marginGap110 / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                        
                        // å–å…©è€…è¼ƒå¤§å€¼
                        const dailyTarget110 = Math.max(dailyTargetByPerformance110, dailyTargetByMargin110);
                        
                        dailyTargetHtml = `
                            <div class="daily-target-110">
                                <div class="daily-target-110-label">æ¥­ç¸¾&æ¯›åˆ©ç›®æ¨™ 110% æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾</div>
                                <div class="daily-target-110-value">${formatNumber(dailyTarget110)}</div>
                            </div>
                        `;
                    }
                    // å¦‚æœæ¥­ç¸¾å’Œæ¯›åˆ©éƒ½é”åˆ° 110%ï¼Œä¸é¡¯ç¤ºä»»ä½•ç›®æ¨™
                }
                
                // å»ºç«‹æ¯›åˆ©é¡é”æˆç‡çš„ HTML
                let marginRateHtml = '';
                
                if (store.grossMarginTarget > 0) {
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡ç›®æ¨™å·®ç•°</div>
                            <div>
                                <div class="metric-value ${marginClass}">
                                    ${store.marginDiff >= 0 ? '+' : ''}${formatNumber(store.marginDiff)}
                                </div>
                                <div class="amount">ç›®æ¨™: ${formatNumber(store.grossMarginTarget)} | å¯¦éš›: ${formatNumber(store.grossMarginAmount)}</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡é”æˆç‡</div>
                            <div style="flex: 1;">
                                <div class="metric-value ${marginClass}">
                                    ${store.marginRate.toFixed(1)}%
                                    ${store.marginRate >= 100 ? '<span class="percentage positive">âœ“ é”æ¨™</span>' : ''}
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar-bg">
                                        <div class="progress-bar ${marginClass}" style="width: ${Math.min(store.marginRate, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (store.grossMarginAmount !== 0) {
                    const amountClass = store.grossMarginAmount >= 0 ? 'neutral' : 'negative';
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">å¯¦éš›æ¯›åˆ©é¡</div>
                            <div>
                                <div class="metric-value ${amountClass}">
                                    ${formatNumber(store.grossMarginAmount)}
                                </div>
                                <div class="amount">ï¼ˆç„¡ç›®æ¨™è³‡æ–™ï¼‰</div>
                            </div>
                        </div>
                    `;
                } else {
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡è³‡æ–™</div>
                            <div class="metric-value" style="color: #999;">
                                ç„¡è³‡æ–™
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="store-name">${store.name}</div>
                    
                    <div class="metric-row">
                        <div class="metric-label">ç›®æ¨™æ¥­ç¸¾å·®ç•°</div>
                        <div>
                            <div class="metric-value ${performanceClass}">
                                ${store.performanceDiff >= 0 ? '+' : ''}${formatNumber(store.performanceDiff)}
                            </div>
                            <div class="amount">ç›®æ¨™: ${formatNumber(store.targetPerformance)} | ç›®å‰: ${formatNumber(store.currentPerformance)}</div>
                        </div>
                    </div>
                    
                    <div class="metric-row">
                        <div class="metric-label">æ¥­ç¸¾é”æˆç‡</div>
                        <div style="flex: 1;">
                            <div class="metric-value ${performanceClass}">
                                ${store.performanceRate.toFixed(1)}%
                                ${store.performanceRate >= 100 ? '<span class="percentage positive">âœ“ é”æ¨™</span>' : ''}
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar-bg">
                                    <div class="progress-bar ${performanceClass}" style="width: ${Math.min(store.performanceRate, 100)}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${marginRateHtml}
                    
                    ${store.grossMarginRate !== 0 ? `
                        <div class="metric-row">
                            <div class="metric-label">æ•´é«”æ¯›åˆ©ç‡</div>
                            <div class="metric-value ${store.grossMarginRate >= 0 ? 'neutral' : 'negative'}">
                                ${store.grossMarginRate.toFixed(2)}%
                            </div>
                        </div>
                    ` : ''}
                    
                    ${dailyTargetHtml}
                `;
                
                dashboard.appendChild(card);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num);
        }

        function exportToCSV() {
            // ç²å–ç•¶å‰é¡¯ç¤ºçš„çµæœ
            if (!currentDisplayResults || currentDisplayResults.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥è¼¸å‡º');
                return;
            }

            // ä½¿ç”¨æ˜¨å¤©çš„æ—¥æœŸ
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const year = yesterday.getFullYear();
            const month = yesterday.getMonth() + 1;
            const day = yesterday.getDate();
            
            // è¨ˆç®—è²¡å¹´ä¿¡æ¯å’Œå‰©é¤˜å¤©æ•¸
            const fiscalInfo = calculateFiscalInfo();
            
            // ç²å–ç•¶å‰å€åŸŸ
            const currentRegion = document.querySelector('.region-btn.active').dataset.region;
            
            // CSVæ¨™é ­
            const headers = [
                'åº—å®¶',
                'ç›®æ¨™æ¥­ç¸¾',
                'ç›®å‰æ¥­ç¸¾',
                'é”æˆç‡',
                'æ¥­ç¸¾å·®ç•°',
                'æ¯›åˆ©é¡ç›®æ¨™',
                'ç›®å‰æ¯›åˆ©é¡',
                'æ¯›åˆ©é¡é”æˆç‡',
                'æ¯›åˆ©é¡å·®ç•°',
                'é ä¼°æ¯›åˆ©ç‡',
                'å¯¦éš›æ¯›åˆ©ç‡',
                'æ¯›åˆ©ç‡å·®ç•°',
                '100%å«ç¨…æ¯æ—¥',
                '110%å«ç¨…æ¯æ—¥'
            ];

            // æ§‹å»ºCSVå…§å®¹
            let csvContent = '\uFEFF'; // UTF-8 BOM for Excel
            
            // æ·»åŠ æ¨™é¡Œè¡Œï¼šç´¯è¨ˆè‡³æ˜¨æ—¥å’Œå‰©é¤˜å¤©æ•¸
            csvContent += `ç´¯è¨ˆè‡³æ˜¨æ—¥ ${month}/${day}   æœ¬æœˆå‰©é¤˜å¤©æ•¸ï¼š${fiscalInfo.remainingDays}å¤©\n`;
            csvContent += '\n'; // ç©ºä¸€è¡Œ
            
            csvContent += headers.join(',') + '\n';

            // æ·»åŠ å„åº—æ•¸æ“š
            currentDisplayResults.forEach(store => {
                const row = [
                    `"${store.name}"`,
                    Math.round(store.targetPerformance),
                    Math.round(store.currentPerformance),
                    store.performanceRate.toFixed(1) + '%',
                    Math.round(store.performanceDiff),
                    store.grossMarginTarget > 0 ? Math.round(store.grossMarginTarget) : '',
                    store.grossMarginAmount !== 0 ? Math.round(store.grossMarginAmount) : '',
                    store.grossMarginTarget > 0 ? store.marginRate.toFixed(1) + '%' : '',
                    store.grossMarginTarget > 0 ? Math.round(store.marginDiff) : '',
                    store.estimatedMarginRate !== 0 ? store.estimatedMarginRate.toFixed(2) + '%' : '',
                    store.actualMarginRate !== 0 ? store.actualMarginRate.toFixed(2) + '%' : '',
                    store.marginRateDiff !== 0 ? store.marginRateDiff.toFixed(2) + '%' : '',
                    store.dailyTarget100 > 0 ? Math.round(store.dailyTarget100) : '',
                    store.dailyTarget110 > 0 ? Math.round(store.dailyTarget110) : ''
                ];
                csvContent += row.join(',') + '\n';
            });

            // æ·»åŠ ç¸½è¨ˆè¡Œ
            // è¨ˆç®—ç¸½è¨ˆ
            let totals = {
                name: currentRegion,
                currentPerformance: 0,
                targetPerformance: 0,
                grossMarginAmount: 0,
                grossMarginTarget: 0,
                dailyTarget100: 0,
                dailyTarget110: 0
            };

            currentDisplayResults.forEach(store => {
                totals.currentPerformance += store.currentPerformance;
                totals.targetPerformance += store.targetPerformance;
                totals.grossMarginAmount += store.grossMarginAmount;
                totals.grossMarginTarget += store.grossMarginTarget;
                totals.dailyTarget100 += store.dailyTarget100;
                totals.dailyTarget110 += store.dailyTarget110;
            });

            totals.performanceDiff = totals.currentPerformance - totals.targetPerformance;
            totals.performanceRate = totals.targetPerformance > 0 ? (totals.currentPerformance / totals.targetPerformance) * 100 : 0;
            totals.marginDiff = totals.grossMarginAmount - totals.grossMarginTarget;
            totals.marginRate = totals.grossMarginTarget > 0 ? (totals.grossMarginAmount / totals.grossMarginTarget) * 100 : 0;
            totals.grossMarginRate = totals.currentPerformance > 0 ? (totals.grossMarginAmount / totals.currentPerformance) * 100 : 0;

            // è¨ˆç®—æ¯›åˆ©ç‡ï¼ˆåŠ æ¬Šå¹³å‡ï¼‰
            let totalEstimatedMargin = 0;
            let totalActualMargin = 0;
            currentDisplayResults.forEach(store => {
                if (store.estimatedMarginRate !== 0 && store.currentPerformance > 0) {
                    totalEstimatedMargin += (store.estimatedMarginRate / 100) * store.currentPerformance;
                }
                if (store.actualMarginRate !== 0 && store.currentPerformance > 0) {
                    totalActualMargin += (store.actualMarginRate / 100) * store.currentPerformance;
                }
            });

            totals.estimatedMarginRate = totals.currentPerformance > 0 ? (totalEstimatedMargin / totals.currentPerformance) * 100 : 0;
            totals.actualMarginRate = totals.currentPerformance > 0 ? (totalActualMargin / totals.currentPerformance) * 100 : 0;
            totals.marginRateDiff = totals.actualMarginRate - totals.estimatedMarginRate;

            const totalRow = [
                `"${totals.name}ç¸½è¨ˆ"`,
                Math.round(totals.targetPerformance),
                Math.round(totals.currentPerformance),
                totals.performanceRate.toFixed(1) + '%',
                Math.round(totals.performanceDiff),
                Math.round(totals.grossMarginTarget),
                Math.round(totals.grossMarginAmount),
                totals.marginRate.toFixed(1) + '%',
                Math.round(totals.marginDiff),
                totals.estimatedMarginRate !== 0 ? totals.estimatedMarginRate.toFixed(2) + '%' : '',
                totals.actualMarginRate !== 0 ? totals.actualMarginRate.toFixed(2) + '%' : '',
                totals.marginRateDiff !== 0 ? totals.marginRateDiff.toFixed(2) + '%' : '',
                totals.dailyTarget100 > 0 ? Math.round(totals.dailyTarget100) : '',
                totals.dailyTarget110 > 0 ? Math.round(totals.dailyTarget110) : ''
            ];
            csvContent += totalRow.join(',') + '\n';

            // å‰µå»ºä¸‹è¼‰é€£çµ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `æ¥­ç¸¾ç¸½è¦½_${currentRegion}_${year}å¹´${month}æœˆ${day}æ—¥.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Modal ç›¸é—œå‡½æ•¸
        function showStoreDetail(index) {
            const store = currentDisplayResults[index];
            if (!store) return;
            
            const modal = document.getElementById('storeDetailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `${store.name} - æ¯æ—¥æ¥­ç¸¾æ˜ç´°`;
            
            // å°ç£åœ‹å®šå‡æ—¥åˆ¤æ–·å‡½æ•¸
            function isTaiwanHoliday(dateStr) {
                if (!dateStr) return false;
                
                // è§£ææ—¥æœŸå­—ä¸² "11æœˆ1æ—¥" -> month: 11, day: 1
                const match = dateStr.match(/(\d+)æœˆ(\d+)æ—¥/);
                if (!match) return false;
                
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                
                // 2024å¹´å°ç£åœ‹å®šå‡æ—¥åˆ—è¡¨
                const holidays2024 = [
                    {month: 1, day: 1},   // å…ƒæ—¦
                    {month: 2, day: 8},   // å°å¹´å¤œï¼ˆ2024ï¼‰
                    {month: 2, day: 9},   // é™¤å¤•ï¼ˆ2024ï¼‰
                    {month: 2, day: 10},  // æ˜¥ç¯€åˆä¸€ï¼ˆ2024ï¼‰
                    {month: 2, day: 11},  // æ˜¥ç¯€åˆäºŒï¼ˆ2024ï¼‰
                    {month: 2, day: 12},  // æ˜¥ç¯€åˆä¸‰ï¼ˆ2024ï¼‰
                    {month: 2, day: 13},  // æ˜¥ç¯€åˆå››ï¼ˆ2024ï¼‰
                    {month: 2, day: 14},  // æ˜¥ç¯€åˆäº”ï¼ˆ2024ï¼‰
                    {month: 2, day: 28},  // å’Œå¹³ç´€å¿µæ—¥
                    {month: 4, day: 4},   // å…’ç«¥ç¯€
                    {month: 4, day: 5},   // æ¸…æ˜ç¯€ï¼ˆ2024ï¼‰
                    {month: 6, day: 10},  // ç«¯åˆç¯€ï¼ˆ2024ï¼‰
                    {month: 9, day: 17},  // ä¸­ç§‹ç¯€ï¼ˆ2024ï¼‰
                    {month: 10, day: 10}, // åœ‹æ…¶æ—¥
                ];
                
                // 2025å¹´å°ç£åœ‹å®šå‡æ—¥åˆ—è¡¨
                const holidays2025 = [
                    {month: 1, day: 1},   // å…ƒæ—¦
                    {month: 1, day: 27},  // å°å¹´å¤œï¼ˆ2025ï¼‰
                    {month: 1, day: 28},  // é™¤å¤•ï¼ˆ2025ï¼‰
                    {month: 1, day: 29},  // æ˜¥ç¯€åˆä¸€ï¼ˆ2025ï¼‰
                    {month: 1, day: 30},  // æ˜¥ç¯€åˆäºŒï¼ˆ2025ï¼‰
                    {month: 1, day: 31},  // æ˜¥ç¯€åˆä¸‰ï¼ˆ2025ï¼‰
                    {month: 2, day: 1},   // æ˜¥ç¯€åˆå››ï¼ˆ2025ï¼‰
                    {month: 2, day: 2},   // æ˜¥ç¯€åˆäº”ï¼ˆ2025ï¼‰
                    {month: 2, day: 28},  // å’Œå¹³ç´€å¿µæ—¥
                    {month: 4, day: 3},   // å…’ç«¥ç¯€ï¼ˆ2025ï¼‰
                    {month: 4, day: 4},   // æ¸…æ˜ç¯€ï¼ˆ2025ï¼‰
                    {month: 5, day: 31},  // ç«¯åˆç¯€ï¼ˆ2025ï¼‰
                    {month: 10, day: 6},  // ä¸­ç§‹ç¯€ï¼ˆ2025ï¼‰
                    {month: 10, day: 10}, // åœ‹æ…¶æ—¥
                ];
                
                // 2026å¹´å°ç£åœ‹å®šå‡æ—¥åˆ—è¡¨ï¼ˆå¯ç¹¼çºŒæ“´å……ï¼‰
                const holidays2026 = [
                    {month: 1, day: 1},   // å…ƒæ—¦
                    {month: 2, day: 16},  // å°å¹´å¤œï¼ˆ2026ï¼‰
                    {month: 2, day: 17},  // é™¤å¤•ï¼ˆ2026ï¼‰
                    {month: 2, day: 18},  // æ˜¥ç¯€åˆä¸€ï¼ˆ2026ï¼‰
                    {month: 2, day: 19},  // æ˜¥ç¯€åˆäºŒï¼ˆ2026ï¼‰
                    {month: 2, day: 20},  // æ˜¥ç¯€åˆä¸‰ï¼ˆ2026ï¼‰
                    {month: 2, day: 21},  // æ˜¥ç¯€åˆå››ï¼ˆ2026ï¼‰
                    {month: 2, day: 22},  // æ˜¥ç¯€åˆäº”ï¼ˆ2026ï¼‰
                    {month: 2, day: 28},  // å’Œå¹³ç´€å¿µæ—¥
                    {month: 4, day: 3},   // å…’ç«¥ç¯€ï¼ˆ2026ï¼‰
                    {month: 4, day: 4},   // æ¸…æ˜ç¯€ï¼ˆ2026ï¼‰
                    {month: 6, day: 19},  // ç«¯åˆç¯€ï¼ˆ2026ï¼‰
                    {month: 9, day: 25},  // ä¸­ç§‹ç¯€ï¼ˆ2026ï¼‰
                    {month: 10, day: 10}, // åœ‹æ…¶æ—¥
                ];
                
                // æ ¹æ“šç•¶å‰ç³»çµ±æ—¥æœŸåˆ¤æ–·ä½¿ç”¨å“ªå€‹å¹´ä»½çš„å‡æ—¥åˆ—è¡¨
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                // è²¡å¹´é‚è¼¯ï¼š9/28å¾Œé€²å…¥æ–°è²¡å¹´
                let fiscalYear = currentYear;
                if (currentMonth >= 9 && now.getDate() >= 28) {
                    fiscalYear = currentYear + 1;
                }
                
                // åˆ¤æ–·å ±è¡¨æœˆä»½å°æ‡‰çš„å¹´ä»½
                // å¦‚æœå ±è¡¨æœˆä»½(month)å¤§æ–¼ç­‰æ–¼9æœˆï¼Œä¸”ç•¶å‰åœ¨9æœˆ28æ—¥å¾Œï¼Œå‰‡å ±è¡¨å¹´ä»½ = ç•¶å‰å¹´
                // å¦‚æœå ±è¡¨æœˆä»½å°æ–¼9æœˆï¼Œä¸”ç•¶å‰åœ¨9æœˆ28æ—¥å¾Œï¼Œå‰‡å ±è¡¨å¹´ä»½ = ä¸‹ä¸€å¹´
                let reportYear;
                if (currentMonth >= 9 && now.getDate() >= 28) {
                    // åœ¨9/28ä¹‹å¾Œ
                    if (month >= 9) {
                        reportYear = currentYear;  // 9-12æœˆå ±è¡¨ç”¨ç•¶å¹´
                    } else {
                        reportYear = currentYear + 1;  // 1-8æœˆå ±è¡¨ç”¨ä¸‹ä¸€å¹´
                    }
                } else {
                    // åœ¨9/28ä¹‹å‰
                    if (month >= 9) {
                        reportYear = currentYear - 1;  // 9-12æœˆå ±è¡¨ç”¨å»å¹´
                    } else {
                        reportYear = currentYear;  // 1-8æœˆå ±è¡¨ç”¨ç•¶å¹´
                    }
                }
                
                // æ ¹æ“šå ±è¡¨å¹´ä»½é¸æ“‡å‡æ—¥åˆ—è¡¨
                let holidays;
                if (reportYear === 2024) {
                    holidays = holidays2024;
                } else if (reportYear === 2025) {
                    holidays = holidays2025;
                } else if (reportYear === 2026) {
                    holidays = holidays2026;
                } else {
                    // é è¨­ä½¿ç”¨2025å¹´å‡æ—¥åˆ—è¡¨
                    holidays = holidays2025;
                }
                
                return holidays.some(h => h.month === month && h.day === day);
            }
            
            // è¨ˆç®—åˆè¨ˆ
            let totalSelf = 0;
            let totalCounter = 0;
            let totalAll = 0;
            
            store.dailyData.forEach(day => {
                totalSelf += day.selfSales;
                totalCounter += day.counterSales;
                totalAll += day.totalSales;
            });
            
            // ç”Ÿæˆè¡¨æ ¼
            let tableHTML = `
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ˜ŸæœŸ</th>
                            <th>è‡ªç‡Ÿ</th>
                            <th>å°ˆæ«ƒ</th>
                            <th>åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            store.dailyData.forEach(day => {
                // åˆ¤æ–·æ˜¯å¦ç‚ºå‡æ—¥ï¼šé€±å…­æ—¥æˆ–åœ‹å®šå‡æ—¥
                const isWeekendHoliday = day.weekday === 'Sat' || day.weekday === 'Sun';
                const isNationalHoliday = isTaiwanHoliday(day.date);
                const isHoliday = isWeekendHoliday || isNationalHoliday;
                const holidayClass = isHoliday ? ' class="holiday"' : '';
                
                tableHTML += `
                    <tr>
                        <td${holidayClass}>${day.date || ''}</td>
                        <td${holidayClass}>${day.weekday || ''}</td>
                        <td>${day.selfSales > 0 ? formatNumber(day.selfSales) : '0'}</td>
                        <td>${day.counterSales > 0 ? formatNumber(day.counterSales) : '0'}</td>
                        <td>${day.totalSales > 0 ? formatNumber(day.totalSales) : '0'}</td>
                    </tr>
                `;
            });
            
            // åˆè¨ˆè¡Œ
            tableHTML += `
                    <tr class="total-row">
                        <td colspan="2">åˆè¨ˆ</td>
                        <td>${formatNumber(totalSelf)}</td>
                        <td>${formatNumber(totalCounter)}</td>
                        <td>${formatNumber(totalAll)}</td>
                    </tr>
            `;
            
            // æœ¬æœˆç›®æ¨™è¡Œï¼ˆä½¿ç”¨å¯¦éš›æ•¸æ“šï¼‰
            const targetSelf = store.targetSelf || 0;
            const targetCounter = store.targetCounter || 0;
            tableHTML += `
                    <tr>
                        <td colspan="2">æœ¬æœˆç›®æ¨™</td>
                        <td>${targetSelf > 0 ? formatNumber(targetSelf) : '-'}</td>
                        <td>${targetCounter > 0 ? formatNumber(targetCounter) : '-'}</td>
                        <td>${store.targetPerformance > 0 ? formatNumber(store.targetPerformance) : '-'}</td>
                    </tr>
            `;
            
            // é”æˆç‡è¡Œ
            const achievementSelf = targetSelf > 0 ? (totalSelf / targetSelf) * 100 : 0;
            const achievementCounter = targetCounter > 0 ? (totalCounter / targetCounter) * 100 : 0;
            tableHTML += `
                    <tr>
                        <td colspan="2">é”æˆç‡</td>
                        <td class="${achievementSelf >= 100 ? 'positive-value' : 'negative-value'}">${targetSelf > 0 ? achievementSelf.toFixed(2) + '%' : '-'}</td>
                        <td class="${achievementCounter >= 100 ? 'positive-value' : 'negative-value'}">${targetCounter > 0 ? achievementCounter.toFixed(2) + '%' : '-'}</td>
                        <td class="${store.performanceRate >= 100 ? 'positive-value' : 'negative-value'}">${store.performanceRate.toFixed(2)}%</td>
                    </tr>
            `;
            
            // å»å¹´æœ¬æœˆå¯¦ç¸¾è¡Œ
            if (store.lastYearPerformance && store.lastYearPerformance > 0) {
                tableHTML += `
                    <tr>
                        <td colspan="2">å»å¹´æœ¬æœˆå¯¦ç¸¾</td>
                        <td>${store.lastYearSelf > 0 ? formatNumber(store.lastYearSelf) : '-'}</td>
                        <td>${store.lastYearCounter > 0 ? formatNumber(store.lastYearCounter) : '-'}</td>
                        <td>${formatNumber(store.lastYearPerformance)}</td>
                    </tr>
                `;
            }
            
            // æˆé•·ç‡è¡Œ
            if (store.growthRate !== undefined) {
                tableHTML += `
                    <tr>
                        <td colspan="2">æˆé•·ç‡</td>
                        <td class="${store.growthRateSelf >= 0 ? 'positive-value' : 'negative-value'}">${store.growthRateSelf.toFixed(2)}%</td>
                        <td class="${store.growthRateCounter >= 0 ? 'positive-value' : 'negative-value'}">${store.growthRateCounter.toFixed(2)}%</td>
                        <td class="${store.growthRate >= 0 ? 'positive-value' : 'negative-value'}">${store.growthRate.toFixed(2)}%</td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            modalBody.innerHTML = tableHTML;
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('storeDetailModal');
            modal.style.display = 'none';
        }

        // é»æ“Š modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('storeDetailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            // è¨ˆç®—ä¸¦é¡¯ç¤ºç•¶æ—¥è²¡å¹´ä¿¡æ¯
            const fiscalInfo = calculateFiscalInfo();
            const headerSubtitle = document.getElementById('headerSubtitle');
            if (headerSubtitle) {
                headerSubtitle.textContent = `FY${fiscalInfo.fiscalYear}Q${fiscalInfo.quarter}W${fiscalInfo.week} ${fiscalInfo.today}`;
            }
        });
    </script>

    <footer class="footer">
        Created by Morio Â© 2025
    </footer>
</body>
</html>
