<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«‹å±•æ¥­ç¸¾å ±è¡¨åˆ†æ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid #3d3d3d;
        }

        h1 {
            color: #e0e0e0;
            font-size: 2em;
            margin-bottom: 8px;
        }

        .upload-section {
            background: #2d2d2d;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid #3d3d3d;
        }

        .upload-area {
            border: 3px dashed #4a9eff;
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #252525;
        }

        .upload-area:hover {
            background: #2a2a2a;
            border-color: #5db0ff;
        }

        .upload-area.dragover {
            background: #303030;
            border-color: #5db0ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #4a9eff;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1em;
            color: #b0b0b0;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            background: #3a8eef;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 158, 255, 0.4);
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        .store-card {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 1px solid #3d3d3d;
        }

        .store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
            border-color: #4a9eff;
        }

        .total-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
            border: 2px solid #4a9eff;
            grid-column: 1 / -1;
        }

        .total-card .store-name {
            color: #4a9eff;
            font-size: 1.7em;
            border-bottom-color: #4a9eff;
            border-bottom-width: 3px;
        }

        .store-name {
            font-size: 1.5em;
            color: #4a9eff;
            margin-bottom: 15px;
            font-weight: bold;
            border-bottom: 2px solid #4a4a4a;
            padding-bottom: 10px;
            text-align: left;
        }

        .metric-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #3d3d3d;
            gap: 15px;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 0.97em;
            color: #d0d0d0;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.15em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e0e0;
        }

        .positive {
            color: #34d399;
        }

        .negative {
            color: #f87171;
        }

        .neutral {
            color: #4a9eff;
        }

        .percentage {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .percentage.positive {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        .percentage.negative {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .amount {
            font-size: 0.8em;
            color: #888;
            margin-top: 3px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: #2d2d2d;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #3d3d3d;
        }

        .loading-spinner {
            border: 4px solid #3d3d3d;
            border-top: 4px solid #4a9eff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .summary-table-container {
            display: none;
            background: #2d2d2d;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
            border: 1px solid #3d3d3d;
        }

        .summary-table-title {
            font-size: 1.5em;
            color: #4a9eff;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .date-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #252525;
            border-radius: 10px;
            border-left: 4px solid #4a9eff;
        }

        .date-info .main-date {
            font-size: 1.3em;
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .date-info .sub-date {
            font-size: 1.05em;
            color: #b0b0b0;
        }

        .daily-target {
            margin-top: 12px;
            padding: 10px;
            background: rgba(234, 179, 8, 0.1);
            border-radius: 8px;
            border-left: 3px solid #eab308;
        }

        .daily-target-label {
            font-size: 0.85em;
            color: #b0b0b0;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .daily-target-value {
            font-size: 1.1em;
            color: #fbbf24;
            font-weight: bold;
        }

        .daily-target-110 {
            margin-top: 8px;
            padding: 10px;
            background: rgba(249, 115, 22, 0.1);
            border-radius: 8px;
            border-left: 3px solid #f97316;
        }

        .daily-target-110-label {
            font-size: 0.85em;
            color: #b0b0b0;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .daily-target-110-value {
            font-size: 1.1em;
            color: #fb923c;
            font-weight: bold;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .summary-table th {
            background: #252525;
            color: #b0b0b0;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #3d3d3d;
            font-size: 0.9em;
        }

        .summary-table td {
            padding: 8px;
            text-align: right;
            border: 1px solid #3d3d3d;
            color: #e0e0e0;
        }

        .summary-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #b0b0b0;
        }

        .summary-table tbody tr:hover {
            background: #353535;
        }

        .summary-table .total-row {
            background: #252525;
            font-weight: bold;
            border-top: 2px solid #4a9eff;
        }

        .summary-table .total-row td {
            color: #e0e0e0;
        }

        .summary-table .positive-value {
            color: #34d399;
            font-weight: 600;
        }

        .summary-table .negative-value {
            color: #f87171;
            font-weight: 600;
        }

        .summary-table .neutral-value {
            color: #e0e0e0;
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container {
            margin-top: 8px;
            width: 100%;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #3d3d3d;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.6s ease, background 0.3s ease;
            position: relative;
        }

        .progress-bar.positive {
            background: linear-gradient(90deg, #34d399, #10b981);
        }

        .progress-bar.negative {
            background: linear-gradient(90deg, #f87171, #ef4444);
        }

        .progress-text {
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }

        /* å€åŸŸé¸æ“‡å™¨æ¨£å¼ */
        .region-selector {
            background: #2d2d2d;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #3d3d3d;
        }

        .region-title {
            font-size: 1.1em;
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .region-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .region-btn {
            background: #3d3d3d;
            color: #e0e0e0;
            border: 2px solid #4a4a4a;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .region-btn:hover {
            background: #4a4a4a;
            border-color: #4a9eff;
            transform: translateY(-2px);
        }

        .region-btn.active {
            background: #4a9eff;
            color: white;
            border-color: #4a9eff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #dc2626;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: #888;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .metric-row {
                grid-template-columns: 120px 1fr;
                gap: 10px;
            }
            
            .metric-label {
                font-size: 0.85em;
            }
            
            .metric-value {
                font-size: 1em;
            }
            
            .percentage {
                font-size: 0.7em;
                padding: 2px 8px;
            }

            /* è¡¨æ ¼æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
            .summary-table-container {
                padding: 15px;
            }

            .summary-table-title {
                font-size: 1.2em;
            }

            .date-info {
                padding: 10px;
            }

            .date-info .main-date {
                font-size: 0.95em;
            }

            .date-info .sub-date {
                font-size: 0.8em;
            }

            .summary-table {
                font-size: 0.8em;
            }

            .summary-table th,
            .summary-table td {
                padding: 8px 4px;
            }

            /* æ‰‹æ©Ÿç‰ˆéš±è—ç›®æ¨™æ¬„ä½ */
            .summary-table th:nth-child(2),
            .summary-table td:nth-child(2),
            .summary-table th:nth-child(6),
            .summary-table td:nth-child(6) {
                display: none;
            }

            .daily-target {
                padding: 8px;
                margin-top: 8px;
            }

            .daily-target-label {
                font-size: 0.8em;
            }

            .daily-target-value {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ç«‹å±•æ¥­ç¸¾å ±è¡¨åˆ†æç³»çµ±</h1>
            <p style="color: #b0b0b0; font-size: 1.1em; margin-top: 10px;">ä¸Šå‚³æ¯æ—¥æ¥­ç¸¾å ±è¡¨ï¼Œå³æ™‚æŸ¥çœ‹å„åº—è¡¨ç¾</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ›³Excelæª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</div>
                <div style="color: #999; margin-top: 10px;">æ”¯æ´æ ¼å¼ï¼š.xlsx, .xls</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <button class="btn" onclick="document.getElementById('fileInput').click()">é¸æ“‡æª”æ¡ˆ</button>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- å€åŸŸé¸æ“‡å™¨ -->
        <div class="region-selector" id="regionSelector" style="display: none;">
            <div class="region-title">é¸æ“‡å€åŸŸ</div>
            <div class="region-buttons">
                <button class="region-btn active" data-region="å…¨ç¤¾">å…¨ç¤¾</button>
                <button class="region-btn" data-region="åŒ—ä¸€å€">åŒ—ä¸€å€</button>
                <button class="region-btn" data-region="åŒ—äºŒå€">åŒ—äºŒå€</button>
                <button class="region-btn" data-region="ä¸­å€">ä¸­å€</button>
                <button class="region-btn" data-region="å°å—å€">å°å—å€</button>
                <button class="region-btn" data-region="é«˜é›„å€">é«˜é›„å€</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div style="color: #4a9eff; font-size: 1.2em;">æ­£åœ¨åˆ†æè³‡æ–™...</div>
        </div>

        <div class="summary-table-container" id="summaryTable">
            <div class="summary-table-title">ğŸ“Š æ¥­ç¸¾ç¸½è¦½</div>
            <div class="date-info" id="dateInfo">
                <!-- æ—¥æœŸè³‡è¨Šå°‡ç”±JavaScriptç”Ÿæˆ -->
            </div>
            <table class="summary-table" id="summaryTableContent">
                <!-- è¡¨æ ¼å…§å®¹å°‡ç”±JavaScriptç”Ÿæˆ -->
            </table>
        </div>

        <div class="dashboard" id="dashboard"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const dashboard = document.getElementById('dashboard');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const regionSelector = document.getElementById('regionSelector');

        // å…¨å±€è®Šæ•¸å­˜å„²è™•ç†å¾Œçš„æ•¸æ“š
        let allStoresData = [];
        let currentRegion = 'å…¨ç¤¾';

        // åº—å®¶é…ç½®ï¼šåº—å -> é¡¯ç¤ºåç¨±ï¼ˆä»£è™Ÿï¼‰
        const storeConfig = {
            'NK[i]store': '45',
            'SYA11[i]store': '51',
            'TY[i]store': '65',
            'TC[i]store': '75',
            'ä¸­å‹[i]store': '76',
            'è¥¿é–€[i]store': '86',
            'ä¸­å±±[i]store': '88',
            'ZU[i]store': '115',
            'è€æ–¯[i]store': '81',
            'ä¸‰å¤š[i]store': '116',
            'A4[i]store': '57',
            'TM[i]store': '47',
            'MS[i]store': '48',
            'å‚æ¥Š[i]store': '84',
            'SP[i]store': '117',
            'QP[i]store': '61',
            'MTN[i]store': '89',
            'MOPå°ä¸­[i]store': '77',
            'XBM[i]store': '97',
            'skm online': '820'
        };

        // å€åŸŸå®šç¾©
        const regionConfig = {
            'å…¨ç¤¾': ['45', '47', '48', '51', '57', '61', '65', '75', '76', '77', '81', '84', '86', '88', '89', '97', '115', '116', '117', '820'],
            'åŒ—ä¸€å€': ['45', '47', '48'],
            'åŒ—äºŒå€': ['51', '57', '61', '65'],
            'ä¸­å€': ['75', '76', '77', '81', '84'],
            'å°å—å€': ['86', '88', '89', '97'],
            'é«˜é›„å€': ['115', '116', '117']
        };

        // å€åŸŸåˆ‡æ›åŠŸèƒ½
        document.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰active
                document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
                // æ·»åŠ activeåˆ°ç•¶å‰æŒ‰éˆ•
                this.classList.add('active');
                // æ›´æ–°ç•¶å‰å€åŸŸ
                currentRegion = this.dataset.region;
                // é‡æ–°é¡¯ç¤ºæ•¸æ“š
                if (allStoresData.length > 0) {
                    displayResults(allStoresData);
                }
            });
        });

        // è²¡å¹´è¨ˆç®—å‡½æ•¸
        function calculateFiscalInfo() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // è²¡å¹´å¾æ¯å¹´9æœˆ28æ—¥é–‹å§‹
            const currentYear = today.getFullYear();
            const fyStartMonth = 8; // 9æœˆ (0-indexed)
            const fyStartDay = 28;
            
            // åˆ¤æ–·ç•¶å‰æ—¥æœŸæ‰€å±¬çš„è²¡å¹´
            let fiscalYear;
            let fyStartDate;
            
            if (today.getMonth() > fyStartMonth || (today.getMonth() === fyStartMonth && today.getDate() >= fyStartDay)) {
                // åœ¨9/28ä¹‹å¾Œï¼Œå±¬æ–¼ä¸‹ä¸€è²¡å¹´
                fiscalYear = currentYear + 1;
                fyStartDate = new Date(currentYear, fyStartMonth, fyStartDay);
            } else {
                // åœ¨9/28ä¹‹å‰ï¼Œå±¬æ–¼ç•¶å‰è²¡å¹´
                fiscalYear = currentYear;
                fyStartDate = new Date(currentYear - 1, fyStartMonth, fyStartDay);
            }
            
            // è¨ˆç®—å¾è²¡å¹´é–‹å§‹åˆ°ä»Šå¤©çš„å¤©æ•¸
            const daysSinceFYStart = Math.floor((today - fyStartDate) / (1000 * 60 * 60 * 24));
            
            // è¨ˆç®—å­£åº¦ (æ¯å­£13é€± = 91å¤©)
            const quarter = Math.floor(daysSinceFYStart / 91) + 1;
            
            // è¨ˆç®—å­£åº¦å…§çš„é€±æ•¸
            const daysInQuarter = daysSinceFYStart % 91;
            const weekInQuarter = Math.floor(daysInQuarter / 7) + 1;
            
            // è¨ˆç®—æœ¬æœˆå‰©é¤˜å¤©æ•¸ï¼ˆåŒ…å«ä»Šæ—¥ï¼‰
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const remainingDays = lastDayOfMonth.getDate() - today.getDate() + 1;
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const formatDate = (date) => {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}/${day}`;
            };
            
            return {
                fiscalYear: String(fiscalYear).slice(-2), // FY26 -> 26
                quarter: quarter,
                week: weekInQuarter,
                yesterday: formatDate(yesterday),
                remainingDays: remainingDays,
                currentMonth: today.getMonth() + 1
            };
        }

        // æ‹–æ”¾åŠŸèƒ½
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('è«‹ä¸Šå‚³æœ‰æ•ˆçš„Excelæª”æ¡ˆï¼ˆ.xlsx æˆ– .xlsï¼‰');
                return;
            }

            loading.style.display = 'block';
            dashboard.style.display = 'none';
            errorMessage.style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processData(jsonData);
                } catch (error) {
                    showError('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                    loading.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            try {
                // ========== æ­¥é©Ÿ1ï¼šå‹•æ…‹æŸ¥æ‰¾é—œéµè¡Œçš„ä½ç½® ==========
                const keyRows = {};
                for (let i = 0; i < data.length; i++) {
                    const label = data[i][0];
                    if (label === 'åˆè¨ˆ') keyRows.total = i;
                    else if (label === 'æœ¬æœˆç›®æ¨™') keyRows.target = i;
                    else if (label === 'å¯¦éš›æ¯›åˆ©ç‡(å«éŠ·è£œ)') keyRows.marginRate = i;
                    else if (label === 'å¯¦éš›æ¯›åˆ©é¡(å«éŠ·è£œ)') keyRows.marginAmount = i;
                    else if (label === 'é ä¼°æ¯›åˆ©é¡') keyRows.marginTarget = i;
                    else if (label === 'é ä¼°æ¯›åˆ©ç‡') keyRows.estimatedMarginRate = i;
                }
                
                // é©—è­‰æ˜¯å¦æ‰¾åˆ°é—œéµè¡Œ
                if (!keyRows.total || !keyRows.target) {
                    throw new Error('ç„¡æ³•æ‰¾åˆ°é—œéµè³‡æ–™è¡Œã€‚è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
                }
                
                console.log('æ‰¾åˆ°çš„é—œéµè¡Œä½ç½®ï¼š', keyRows);
                
                // ========== æ­¥é©Ÿ2ï¼šå‹•æ…‹æœç´¢åº—åå’Œåˆ—ä½ç½® ==========
                const storeColumns = {};
                const storeNames = Object.keys(storeConfig);
                
                // åœ¨å‰5è¡Œä¸­æœç´¢åº—å
                for (let rowIdx = 0; rowIdx < 5; rowIdx++) {
                    for (let colIdx = 0; colIdx < data[rowIdx].length; colIdx++) {
                        const cell = data[rowIdx][colIdx];
                        if (cell && storeNames.includes(cell)) {
                            const displayName = storeConfig[cell];
                            
                            // æ‰¾åˆ°åº—åå¾Œï¼Œå¾€å³æ‰¾"åˆè¨ˆ"åˆ—
                            let totalCol = colIdx + 2;  // é è¨­åœ¨+2ä½ç½®
                            
                            // é©—è­‰æ˜¯å¦ç‚ºåˆè¨ˆåˆ—
                            if (rowIdx + 1 < data.length) {
                                for (let c = colIdx; c < Math.min(colIdx + 5, data[rowIdx + 1].length); c++) {
                                    if (data[rowIdx + 1][c] === 'åˆè¨ˆ') {
                                        totalCol = c;
                                        break;
                                    }
                                }
                            }
                            
                            // åœ¨åˆè¨ˆåˆ—é™„è¿‘æœç´¢æ¯›åˆ©è³‡æ–™ï¼ˆå¯èƒ½åœ¨åˆè¨ˆåˆ—æœ¬èº«ï¼Œæˆ–å³å´1-2åˆ—ï¼‰
                            let marginCol = totalCol;
                            let foundMargin = false;
                            
                            if (keyRows.marginAmount) {
                                // å…ˆæª¢æŸ¥åˆè¨ˆåˆ—æœ¬èº«
                                const totalColMargin = parseFloat(data[keyRows.marginAmount][totalCol]);
                                if (!isNaN(totalColMargin) && Math.abs(totalColMargin) > 10) {
                                    marginCol = totalCol;
                                    foundMargin = true;
                                } else {
                                    // åœ¨åˆè¨ˆåˆ—å³å´1-3åˆ—ä¸­æœç´¢
                                    for (let c = totalCol + 1; c < Math.min(totalCol + 4, data[keyRows.marginAmount].length); c++) {
                                        const val = parseFloat(data[keyRows.marginAmount][c]);
                                        if (!isNaN(val) && Math.abs(val) > 10) {
                                            marginCol = c;
                                            foundMargin = true;
                                            break;
                                        }
                                    }
                                    
                                    // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå¾€å·¦å´æœç´¢ï¼ˆé‡å°æŸäº›ç‰¹æ®Šæ ¼å¼ï¼‰
                                    if (!foundMargin) {
                                        for (let c = colIdx; c < totalCol; c++) {
                                            const val = parseFloat(data[keyRows.marginAmount][c]);
                                            if (!isNaN(val) && Math.abs(val) > 10) {
                                                marginCol = c;
                                                foundMargin = true;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            storeColumns[displayName] = { col: totalCol, marginCol: marginCol };
                            
                            console.log(`${displayName}: æ¥­ç¸¾åˆ—=${totalCol}, æ¯›åˆ©åˆ—=${marginCol}, æ‰¾åˆ°æ¯›åˆ©=${foundMargin}`);
                        }
                    }
                }
                
                console.log('æ‰¾åˆ°çš„åº—å®¶åˆ—ä½ç½®ï¼š', storeColumns);
                
                // ========== æ­¥é©Ÿ3ï¼šæå–æ¯å®¶åº—çš„æ•¸æ“š ==========
                const results = [];
                const allStoreNames = Object.values(storeConfig);
                
                allStoreNames.forEach(storeName => {
                    if (!storeColumns[storeName]) {
                        console.warn(`æœªæ‰¾åˆ°åº—å®¶ï¼š${storeName}`);
                        return;
                    }
                    
                    const { col, marginCol } = storeColumns[storeName];
                    
                    // æå–æ•¸æ“š
                    const currentPerformance = parseFloat(data[keyRows.total][col]) || 0;
                    const targetPerformance = parseFloat(data[keyRows.target][col]) || 0;
                    const grossMarginTarget = keyRows.marginTarget ? (parseFloat(data[keyRows.marginTarget][marginCol]) || 0) : 0;
                    const grossMarginRate = keyRows.marginRate ? (parseFloat(data[keyRows.marginRate][marginCol]) || 0) : 0;
                    const grossMarginAmount = keyRows.marginAmount ? (parseFloat(data[keyRows.marginAmount][marginCol]) || 0) : 0;
                    const estimatedMarginRate = keyRows.estimatedMarginRate ? (parseFloat(data[keyRows.estimatedMarginRate][marginCol]) || 0) : 0;
                    const actualMarginRate = grossMarginRate; // å¯¦éš›æ¯›åˆ©ç‡(å«éŠ·è£œ)

                    // è¨ˆç®—é”æˆç‡å’Œå·®ç•°
                    const performanceRate = targetPerformance > 0 ? (currentPerformance / targetPerformance) * 100 : 0;
                    const performanceDiff = currentPerformance - targetPerformance;
                    const marginRate = grossMarginTarget > 0 ? (grossMarginAmount / grossMarginTarget) * 100 : 0;
                    const marginDiff = grossMarginAmount - grossMarginTarget;
                    const marginRateDiff = actualMarginRate - estimatedMarginRate; // æ¯›åˆ©ç‡å·®ç•°

                    results.push({
                        name: storeName,
                        currentPerformance,
                        targetPerformance,
                        performanceRate,
                        performanceDiff,
                        grossMarginAmount,
                        grossMarginTarget,
                        marginRate,
                        marginDiff,
                        grossMarginRate: grossMarginRate * 100,
                        estimatedMarginRate: estimatedMarginRate * 100,
                        actualMarginRate: actualMarginRate * 100,
                        marginRateDiff: marginRateDiff * 100
                    });
                    
                    console.log(`${storeName}æ•¸æ“šï¼š`, {
                        æ¥­ç¸¾: currentPerformance,
                        ç›®æ¨™: targetPerformance,
                        æ¯›åˆ©é¡: grossMarginAmount
                    });
                });

                // å­˜å„²æ‰€æœ‰åº—å®¶æ•¸æ“š
                allStoresData = results;
                
                // é¡¯ç¤ºå€åŸŸé¸æ“‡å™¨
                regionSelector.style.display = 'block';
                
                displayResults(results);
            } catch (error) {
                console.error('è™•ç†éŒ¯èª¤ï¼š', error);
                showError('è³‡æ–™è™•ç†å¤±æ•—ï¼š' + error.message);
                loading.style.display = 'none';
            }
        }

        function displayResults(allResults) {
            dashboard.innerHTML = '';
            
            // æ ¹æ“šç•¶å‰å€åŸŸéæ¿¾åº—å®¶ä¸¦æŒ‰é †åºæ’åˆ—
            const regionStores = regionConfig[currentRegion];
            const results = regionStores
                .map(storeName => allResults.find(store => store.name === storeName))
                .filter(store => store !== undefined);
            
            // è¨ˆç®—è²¡å¹´ä¿¡æ¯
            const fiscalInfo = calculateFiscalInfo();
            
            // è¨ˆç®—ç¸½å’Œ
            const totals = {
                name: currentRegion,
                currentPerformance: 0,
                targetPerformance: 0,
                grossMarginAmount: 0,
                grossMarginTarget: 0,
                performanceRate: 0,
                performanceDiff: 0,
                marginRate: 0,
                marginDiff: 0,
                grossMarginRate: 0,
                estimatedMarginRate: 0,
                actualMarginRate: 0,
                marginRateDiff: 0
            };
            
            results.forEach(store => {
                totals.currentPerformance += store.currentPerformance;
                totals.targetPerformance += store.targetPerformance;
                totals.grossMarginAmount += store.grossMarginAmount;
                totals.grossMarginTarget += store.grossMarginTarget;
            });
            
            totals.performanceDiff = totals.currentPerformance - totals.targetPerformance;
            totals.performanceRate = totals.targetPerformance > 0 ? (totals.currentPerformance / totals.targetPerformance) * 100 : 0;
            totals.marginDiff = totals.grossMarginAmount - totals.grossMarginTarget;
            totals.marginRate = totals.grossMarginTarget > 0 ? (totals.grossMarginAmount / totals.grossMarginTarget) * 100 : 0;
            totals.grossMarginRate = totals.currentPerformance > 0 ? (totals.grossMarginAmount / totals.currentPerformance) * 100 : 0;
            
            // è¨ˆç®—é ä¼°æ¯›åˆ©ç‡ï¼ˆåŠ æ¬Šå¹³å‡ï¼‰
            let totalEstimatedMargin = 0;
            let totalActualMargin = 0;
            results.forEach(store => {
                if (store.estimatedMarginRate !== 0 && store.currentPerformance > 0) {
                    totalEstimatedMargin += (store.estimatedMarginRate / 100) * store.currentPerformance;
                }
                if (store.actualMarginRate !== 0 && store.currentPerformance > 0) {
                    totalActualMargin += (store.actualMarginRate / 100) * store.currentPerformance;
                }
            });
            totals.estimatedMarginRate = totals.currentPerformance > 0 ? (totalEstimatedMargin / totals.currentPerformance) * 100 : 0;
            totals.actualMarginRate = totals.currentPerformance > 0 ? (totalActualMargin / totals.currentPerformance) * 100 : 0;
            totals.marginRateDiff = totals.actualMarginRate - totals.estimatedMarginRate;
            
            // é¡¯ç¤ºæ—¥æœŸä¿¡æ¯
            displayDateInfo(fiscalInfo);
            
            // ç”Ÿæˆè¡¨æ ¼
            generateSummaryTable(results, totals);
            
            // å…ˆé¡¯ç¤ºç¸½å’Œå¡ç‰‡
            createStoreCard(totals, true, fiscalInfo);
            
            // å†é¡¯ç¤ºå„åº—å¡ç‰‡
            results.forEach(store => {
                createStoreCard(store, false, fiscalInfo);
            });

            loading.style.display = 'none';
            document.getElementById('summaryTable').style.display = 'block';
            dashboard.style.display = 'grid';
        }

        function displayDateInfo(fiscalInfo) {
            const dateInfoDiv = document.getElementById('dateInfo');
            dateInfoDiv.innerHTML = `
                <div class="main-date">
                    ğŸ“… FY${fiscalInfo.fiscalYear}Q${fiscalInfo.quarter}W${fiscalInfo.week} ${fiscalInfo.yesterday}
                </div>
                <div class="sub-date">
                    æœ¬æœˆå‰©é¤˜å¤©æ•¸ï¼š${fiscalInfo.remainingDays} å¤©
                </div>
            `;
        }

        function generateSummaryTable(results, totals) {
            const tableContent = document.getElementById('summaryTableContent');
            
            let html = `
                <thead>
                    <tr>
                        <th>åº—å®¶</th>
                        <th>ç›®æ¨™æ¥­ç¸¾</th>
                        <th>ç›®å‰æ¥­ç¸¾</th>
                        <th>é”æˆç‡</th>
                        <th>æ¥­ç¸¾å·®ç•°</th>
                        <th>æ¯›åˆ©é¡ç›®æ¨™</th>
                        <th>ç›®å‰æ¯›åˆ©é¡</th>
                        <th>æ¯›åˆ©é¡é”æˆç‡</th>
                        <th>æ¯›åˆ©é¡å·®ç•°</th>
                        <th>é ä¼°æ¯›åˆ©ç‡</th>
                        <th>å¯¦éš›æ¯›åˆ©ç‡</th>
                        <th>æ¯›åˆ©ç‡å·®ç•°</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // å„åº—è³‡æ–™
            results.forEach(store => {
                const perfDiffClass = store.performanceDiff >= 0 ? 'positive-value' : 'negative-value';
                const perfRateClass = store.performanceRate >= 100 ? 'positive-value' : 'negative-value';
                const marginDiffClass = store.marginDiff >= 0 ? 'positive-value' : 'negative-value';
                const marginRateClass = store.marginRate >= 100 ? 'positive-value' : 'negative-value';
                
                // åˆ¤æ–·æ˜¯å¦éœ€è¦åŠ ç¬¦è™Ÿ
                let storeName = store.name;
                if (store.performanceRate >= 110 && store.marginRate >= 110) {
                    // æ¥­ç¸¾é”æˆç‡å’Œæ¯›åˆ©é¡é”æˆç‡éƒ½>=110%ï¼šé‘½çŸ³
                    storeName = `${store.name} ğŸ’`;
                } else if (store.performanceRate >= 100 && store.marginRate >= 100) {
                    // æ¥­ç¸¾é”æˆç‡å’Œæ¯›åˆ©é¡é”æˆç‡éƒ½>=100%ï¼šçš‡å† 
                    storeName = `${store.name} ğŸ‘‘`;
                }
                
                html += `
                    <tr>
                        <td>${storeName}</td>
                        <td class="neutral-value">${formatNumber(store.targetPerformance)}</td>
                        <td class="neutral-value">${formatNumber(store.currentPerformance)}</td>
                        <td class="${perfRateClass}">${store.performanceRate.toFixed(1)}%</td>
                        <td class="${perfDiffClass}">${store.performanceDiff >= 0 ? '+' : ''}${formatNumber(store.performanceDiff)}</td>
                        <td class="neutral-value">${store.grossMarginTarget > 0 ? formatNumber(store.grossMarginTarget) : '-'}</td>
                        <td class="${store.grossMarginAmount !== 0 ? (store.grossMarginAmount >= 0 ? 'neutral-value' : 'negative-value') : 'neutral-value'}">${store.grossMarginAmount !== 0 ? formatNumber(store.grossMarginAmount) : '-'}</td>
                        <td class="${marginRateClass}">${store.grossMarginTarget > 0 ? store.marginRate.toFixed(1) + '%' : '-'}</td>
                        <td class="${marginDiffClass}">${store.grossMarginTarget > 0 ? (store.marginDiff >= 0 ? '+' : '') + formatNumber(store.marginDiff) : '-'}</td>
                        <td class="neutral-value">${store.estimatedMarginRate !== 0 ? store.estimatedMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td class="neutral-value">${store.actualMarginRate !== 0 ? store.actualMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td class="${store.marginRateDiff >= 0 ? 'positive-value' : 'negative-value'}">${store.marginRateDiff !== 0 ? (store.marginRateDiff >= 0 ? '+' : '') + store.marginRateDiff.toFixed(2) + '%' : '-'}</td>
                    </tr>
                `;
            });
            
            // ç¸½è¨ˆè¡Œ
            const totalPerfDiffClass = totals.performanceDiff >= 0 ? 'positive-value' : 'negative-value';
            const totalPerfRateClass = totals.performanceRate >= 100 ? 'positive-value' : 'negative-value';
            const totalMarginDiffClass = totals.marginDiff >= 0 ? 'positive-value' : 'negative-value';
            const totalMarginRateClass = totals.marginRate >= 100 ? 'positive-value' : 'negative-value';
            
            html += `
                    <tr class="total-row">
                        <td>${totals.name}ç¸½è¨ˆ</td>
                        <td>${formatNumber(totals.targetPerformance)}</td>
                        <td>${formatNumber(totals.currentPerformance)}</td>
                        <td class="${totalPerfRateClass}">${totals.performanceRate.toFixed(1)}%</td>
                        <td class="${totalPerfDiffClass}">${totals.performanceDiff >= 0 ? '+' : ''}${formatNumber(totals.performanceDiff)}</td>
                        <td>${formatNumber(totals.grossMarginTarget)}</td>
                        <td>${formatNumber(totals.grossMarginAmount)}</td>
                        <td class="${totalMarginRateClass}">${totals.marginRate.toFixed(1)}%</td>
                        <td class="${totalMarginDiffClass}">${totals.marginDiff >= 0 ? '+' : ''}${formatNumber(totals.marginDiff)}</td>
                        <td>${totals.estimatedMarginRate !== 0 ? totals.estimatedMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td>${totals.actualMarginRate !== 0 ? totals.actualMarginRate.toFixed(2) + '%' : '-'}</td>
                        <td class="${totals.marginRateDiff >= 0 ? 'positive-value' : 'negative-value'}">${totals.marginRateDiff !== 0 ? (totals.marginRateDiff >= 0 ? '+' : '') + totals.marginRateDiff.toFixed(2) + '%' : '-'}</td>
                    </tr>
                </tbody>
            `;
            
            tableContent.innerHTML = html;
        }

        function createStoreCard(store, isTotal, fiscalInfo) {
                const card = document.createElement('div');
                card.className = isTotal ? 'store-card total-card' : 'store-card';
                
                const performanceClass = store.performanceRate >= 100 ? 'positive' : 'negative';
                const marginClass = store.marginRate >= 100 ? 'positive' : 'negative';
                
                // è¨ˆç®—æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾ï¼ˆæ”¾åœ¨æœ€ä¸‹æ–¹ï¼‰
                let dailyTargetHtml = '';
                if (!isTotal && store.grossMarginTarget > 0 && store.grossMarginRate > 0 && fiscalInfo.remainingDays > 0) {
                    const currentMarginRate = store.marginRate; // ç›®å‰æ¯›åˆ©é”æˆç‡
                    
                    // å¦‚æœæœªé”åˆ° 100%ï¼ŒåŒæ™‚é¡¯ç¤º 100% å’Œ 110% ç›®æ¨™
                    if (currentMarginRate < 100) {
                        // 100% ç›®æ¨™
                        const marginGap = store.grossMarginTarget - store.grossMarginAmount;
                        const dailyTarget = (marginGap / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                        
                        // 110% ç›®æ¨™
                        const marginGap110 = (store.grossMarginTarget * 1.1) - store.grossMarginAmount;
                        const dailyTarget110 = (marginGap110 / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                        
                        dailyTargetHtml = `
                            <div class="daily-target">
                                <div class="daily-target-label">æ¥­ç¸¾&æ¯›åˆ©ç›®æ¨™ 100% æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾</div>
                                <div class="daily-target-value">${formatNumber(dailyTarget)}</div>
                            </div>
                            <div class="daily-target-110">
                                <div class="daily-target-110-label">æ¥­ç¸¾&æ¯›åˆ©ç›®æ¨™ 110% æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾</div>
                                <div class="daily-target-110-value">${formatNumber(dailyTarget110)}</div>
                            </div>
                        `;
                    }
                    // å¦‚æœé”åˆ° 100% ä½†æœªé”åˆ° 110%ï¼Œåªé¡¯ç¤º 110% ç›®æ¨™
                    else if (currentMarginRate >= 100 && currentMarginRate < 110) {
                        const marginGap110 = (store.grossMarginTarget * 1.1) - store.grossMarginAmount;
                        const dailyTarget110 = (marginGap110 / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                        
                        dailyTargetHtml = `
                            <div class="daily-target-110">
                                <div class="daily-target-110-label">æ¥­ç¸¾&æ¯›åˆ©ç›®æ¨™ 110% æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾</div>
                                <div class="daily-target-110-value">${formatNumber(dailyTarget110)}</div>
                            </div>
                        `;
                    }
                    // å¦‚æœé”åˆ° 110%ï¼Œä¸é¡¯ç¤ºä»»ä½•ç›®æ¨™
                }
                
                // å»ºç«‹æ¯›åˆ©é¡é”æˆç‡çš„ HTML
                let marginRateHtml = '';
                
                if (store.grossMarginTarget > 0) {
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡é”æˆç‡</div>
                            <div style="flex: 1;">
                                <div class="metric-value ${marginClass}">
                                    ${store.marginRate.toFixed(1)}%
                                    ${store.marginRate >= 100 ? '<span class="percentage positive">âœ“ é”æ¨™</span>' : ''}
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar-bg">
                                        <div class="progress-bar ${marginClass}" style="width: ${Math.min(store.marginRate, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡ç›®æ¨™å·®ç•°</div>
                            <div>
                                <div class="metric-value ${marginClass}">
                                    ${store.marginDiff >= 0 ? '+' : ''}${formatNumber(store.marginDiff)}
                                </div>
                                <div class="amount">ç›®æ¨™: ${formatNumber(store.grossMarginTarget)} | å¯¦éš›: ${formatNumber(store.grossMarginAmount)}</div>
                            </div>
                        </div>
                    `;
                } else if (store.grossMarginAmount !== 0) {
                    const amountClass = store.grossMarginAmount >= 0 ? 'neutral' : 'negative';
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">å¯¦éš›æ¯›åˆ©é¡</div>
                            <div>
                                <div class="metric-value ${amountClass}">
                                    ${formatNumber(store.grossMarginAmount)}
                                </div>
                                <div class="amount">ï¼ˆç„¡ç›®æ¨™è³‡æ–™ï¼‰</div>
                            </div>
                        </div>
                    `;
                } else {
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡è³‡æ–™</div>
                            <div class="metric-value" style="color: #999;">
                                ç„¡è³‡æ–™
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="store-name">${store.name}</div>
                    
                    <div class="metric-row">
                        <div class="metric-label">æ¥­ç¸¾é”æˆç‡</div>
                        <div style="flex: 1;">
                            <div class="metric-value ${performanceClass}">
                                ${store.performanceRate.toFixed(1)}%
                                ${store.performanceRate >= 100 ? '<span class="percentage positive">âœ“ é”æ¨™</span>' : ''}
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar-bg">
                                    <div class="progress-bar ${performanceClass}" style="width: ${Math.min(store.performanceRate, 100)}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-row">
                        <div class="metric-label">ç›®æ¨™æ¥­ç¸¾å·®ç•°</div>
                        <div>
                            <div class="metric-value ${performanceClass}">
                                ${store.performanceDiff >= 0 ? '+' : ''}${formatNumber(store.performanceDiff)}
                            </div>
                            <div class="amount">ç›®æ¨™: ${formatNumber(store.targetPerformance)} | ç›®å‰: ${formatNumber(store.currentPerformance)}</div>
                        </div>
                    </div>
                    
                    ${marginRateHtml}
                    
                    ${store.grossMarginRate !== 0 ? `
                        <div class="metric-row">
                            <div class="metric-label">æ•´é«”æ¯›åˆ©ç‡</div>
                            <div class="metric-value ${store.grossMarginRate >= 0 ? 'neutral' : 'negative'}">
                                ${store.grossMarginRate.toFixed(2)}%
                            </div>
                        </div>
                    ` : ''}
                    
                    ${dailyTargetHtml}
                `;
                
                dashboard.appendChild(card);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
    </script>

    <footer class="footer">
        Created by Morio Â© 2025
    </footer>
</body>
</html>
