<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«‹å±•æ¥­ç¸¾å ±è¡¨åˆ†æ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 8px;
        }

        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #eef1ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e0e7ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1em;
            color: #666;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        .store-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        .total-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f5 100%);
            border: 2px solid #667eea;
            grid-column: 1 / -1;
        }

        .total-card .store-name {
            color: #5a67d8;
            font-size: 1.7em;
            border-bottom-color: #5a67d8;
            border-bottom-width: 3px;
        }

        .store-name {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .metric-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            gap: 15px;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 0.95em;
            color: #555;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.15em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .neutral {
            color: #667eea;
        }

        .percentage {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .percentage.positive {
            background: #d1fae5;
            color: #059669;
        }

        .percentage.negative {
            background: #fee2e2;
            color: #dc2626;
        }

        .amount {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .summary-table-container {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .summary-table-title {
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .date-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .date-info .main-date {
            font-size: 1.3em;
            color: #374151;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .date-info .sub-date {
            font-size: 1.05em;
            color: #6b7280;
        }

        .daily-target {
            margin-top: 12px;
            padding: 10px;
            background: #fff7ed;
            border-radius: 8px;
            border-left: 3px solid #f59e0b;
        }

        .daily-target-label {
            font-size: 0.85em;
            color: #92400e;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .daily-target-value {
            font-size: 1.1em;
            color: #ea580c;
            font-weight: bold;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .summary-table th {
            background: #f3f4f6;
            color: #374151;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            font-size: 0.9em;
        }

        .summary-table td {
            padding: 8px;
            text-align: right;
            border: 1px solid #e5e7eb;
        }

        .summary-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #374151;
        }

        .summary-table tbody tr:hover {
            background: #f9fafb;
        }

        .summary-table .total-row {
            background: #f3f4f6;
            font-weight: bold;
            border-top: 2px solid #667eea;
        }

        .summary-table .total-row td {
            color: #374151;
        }

        .summary-table .positive-value {
            color: #10b981;
            font-weight: 600;
        }

        .summary-table .negative-value {
            color: #ef4444;
            font-weight: 600;
        }

        .summary-table .neutral-value {
            color: #374151;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #dc2626;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .metric-row {
                grid-template-columns: 120px 1fr;
                gap: 10px;
            }
            
            .metric-label {
                font-size: 0.85em;
            }
            
            .metric-value {
                font-size: 1em;
            }
            
            .percentage {
                font-size: 0.7em;
                padding: 2px 8px;
            }

            /* è¡¨æ ¼æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
            .summary-table-container {
                padding: 15px;
            }

            .summary-table-title {
                font-size: 1.2em;
            }

            .date-info {
                padding: 10px;
            }

            .date-info .main-date {
                font-size: 0.95em;
            }

            .date-info .sub-date {
                font-size: 0.8em;
            }

            .summary-table {
                font-size: 0.8em;
            }

            .summary-table th,
            .summary-table td {
                padding: 8px 4px;
            }

            /* æ‰‹æ©Ÿç‰ˆéš±è—ç›®æ¨™æ¬„ä½ */
            .summary-table th:nth-child(2),
            .summary-table td:nth-child(2),
            .summary-table th:nth-child(6),
            .summary-table td:nth-child(6) {
                display: none;
            }

            .daily-target {
                padding: 8px;
                margin-top: 8px;
            }

            .daily-target-label {
                font-size: 0.8em;
            }

            .daily-target-value {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ç«‹å±•æ¥­ç¸¾å ±è¡¨åˆ†æç³»çµ±</h1>
            <p style="color: #666; font-size: 1.1em; margin-top: 10px;">ä¸Šå‚³æ¯æ—¥æ¥­ç¸¾å ±è¡¨ï¼Œå³æ™‚æŸ¥çœ‹å„åº—è¡¨ç¾</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ›³Excelæª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</div>
                <div style="color: #999; margin-top: 10px;">æ”¯æ´æ ¼å¼ï¼š.xlsx, .xls</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <button class="btn" onclick="document.getElementById('fileInput').click()">é¸æ“‡æª”æ¡ˆ</button>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div style="color: #667eea; font-size: 1.2em;">æ­£åœ¨åˆ†æè³‡æ–™...</div>
        </div>

        <div class="summary-table-container" id="summaryTable">
            <div class="summary-table-title">ğŸ“Š æ¥­ç¸¾ç¸½è¦½</div>
            <div class="date-info" id="dateInfo">
                <!-- æ—¥æœŸè³‡è¨Šå°‡ç”±JavaScriptç”Ÿæˆ -->
            </div>
            <table class="summary-table" id="summaryTableContent">
                <!-- è¡¨æ ¼å…§å®¹å°‡ç”±JavaScriptç”Ÿæˆ -->
            </table>
        </div>

        <div class="dashboard" id="dashboard"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const dashboard = document.getElementById('dashboard');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');

        // è²¡å¹´è¨ˆç®—å‡½æ•¸
        function calculateFiscalInfo() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // è²¡å¹´å¾æ¯å¹´9æœˆ28æ—¥é–‹å§‹
            const currentYear = today.getFullYear();
            const fyStartMonth = 8; // 9æœˆ (0-indexed)
            const fyStartDay = 28;
            
            // åˆ¤æ–·ç•¶å‰æ—¥æœŸæ‰€å±¬çš„è²¡å¹´
            let fiscalYear;
            let fyStartDate;
            
            if (today.getMonth() > fyStartMonth || (today.getMonth() === fyStartMonth && today.getDate() >= fyStartDay)) {
                // åœ¨9/28ä¹‹å¾Œï¼Œå±¬æ–¼ä¸‹ä¸€è²¡å¹´
                fiscalYear = currentYear + 1;
                fyStartDate = new Date(currentYear, fyStartMonth, fyStartDay);
            } else {
                // åœ¨9/28ä¹‹å‰ï¼Œå±¬æ–¼ç•¶å‰è²¡å¹´
                fiscalYear = currentYear;
                fyStartDate = new Date(currentYear - 1, fyStartMonth, fyStartDay);
            }
            
            // è¨ˆç®—å¾è²¡å¹´é–‹å§‹åˆ°ä»Šå¤©çš„å¤©æ•¸
            const daysSinceFYStart = Math.floor((today - fyStartDate) / (1000 * 60 * 60 * 24));
            
            // è¨ˆç®—å­£åº¦ (æ¯å­£13é€± = 91å¤©)
            const quarter = Math.floor(daysSinceFYStart / 91) + 1;
            
            // è¨ˆç®—å­£åº¦å…§çš„é€±æ•¸
            const daysInQuarter = daysSinceFYStart % 91;
            const weekInQuarter = Math.floor(daysInQuarter / 7) + 1;
            
            // è¨ˆç®—æœ¬æœˆå‰©é¤˜å¤©æ•¸ï¼ˆåŒ…å«ä»Šæ—¥ï¼‰
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const remainingDays = lastDayOfMonth.getDate() - today.getDate() + 1;
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const formatDate = (date) => {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}/${day}`;
            };
            
            return {
                fiscalYear: String(fiscalYear).slice(-2), // FY26 -> 26
                quarter: quarter,
                week: weekInQuarter,
                yesterday: formatDate(yesterday),
                remainingDays: remainingDays,
                currentMonth: today.getMonth() + 1
            };
        }

        // æ‹–æ”¾åŠŸèƒ½
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('è«‹ä¸Šå‚³æœ‰æ•ˆçš„Excelæª”æ¡ˆï¼ˆ.xlsx æˆ– .xlsï¼‰');
                return;
            }

            loading.style.display = 'block';
            dashboard.style.display = 'none';
            errorMessage.style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processData(jsonData);
                } catch (error) {
                    showError('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                    loading.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            try {
                // ========== æ­¥é©Ÿ1ï¼šå‹•æ…‹æŸ¥æ‰¾é—œéµè¡Œçš„ä½ç½® ==========
                const keyRows = {};
                for (let i = 0; i < data.length; i++) {
                    const label = data[i][0];
                    if (label === 'åˆè¨ˆ') keyRows.total = i;
                    else if (label === 'æœ¬æœˆç›®æ¨™') keyRows.target = i;
                    else if (label === 'å¯¦éš›æ¯›åˆ©ç‡(å«éŠ·è£œ)') keyRows.marginRate = i;
                    else if (label === 'å¯¦éš›æ¯›åˆ©é¡(å«éŠ·è£œ)') keyRows.marginAmount = i;
                    else if (label === 'é ä¼°æ¯›åˆ©é¡') keyRows.marginTarget = i;
                }
                
                // é©—è­‰æ˜¯å¦æ‰¾åˆ°é—œéµè¡Œ
                if (!keyRows.total || !keyRows.target) {
                    throw new Error('ç„¡æ³•æ‰¾åˆ°é—œéµè³‡æ–™è¡Œã€‚è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
                }
                
                console.log('æ‰¾åˆ°çš„é—œéµè¡Œä½ç½®ï¼š', keyRows);
                
                // ========== æ­¥é©Ÿ2ï¼šå‹•æ…‹æœç´¢åº—åå’Œåˆ—ä½ç½® ==========
                const storeColumns = {};
                const storeNames = ['TC[i]store', 'ä¸­å‹[i]store', 'MOPå°ä¸­[i]store', 'è€æ–¯[i]store', 'å‚æ¥Š[i]store'];
                const storeDisplayNames = {
                    'TC[i]store': 'ä¸­æ¸¯',
                    'ä¸­å‹[i]store': 'ä¸­å‹',
                    'MOPå°ä¸­[i]store': 'å°ä¸­ä¸‰äº•',
                    'è€æ–¯[i]store': 'è€æ–¯',
                    'å‚æ¥Š[i]store': 'å‚æ¥Š'
                };
                
                // åœ¨å‰5è¡Œä¸­æœç´¢åº—å
                for (let rowIdx = 0; rowIdx < 5; rowIdx++) {
                    for (let colIdx = 0; colIdx < data[rowIdx].length; colIdx++) {
                        const cell = data[rowIdx][colIdx];
                        if (cell && storeNames.includes(cell)) {
                            const displayName = storeDisplayNames[cell];
                            
                            // æ‰¾åˆ°åº—åå¾Œï¼Œå¾€å³æ‰¾"åˆè¨ˆ"åˆ—
                            let totalCol = colIdx + 2;  // é è¨­åœ¨+2ä½ç½®
                            
                            // é©—è­‰æ˜¯å¦ç‚ºåˆè¨ˆåˆ—
                            if (rowIdx + 1 < data.length) {
                                for (let c = colIdx; c < Math.min(colIdx + 5, data[rowIdx + 1].length); c++) {
                                    if (data[rowIdx + 1][c] === 'åˆè¨ˆ') {
                                        totalCol = c;
                                        break;
                                    }
                                }
                            }
                            
                            // åœ¨åˆè¨ˆåˆ—é™„è¿‘æœç´¢æ¯›åˆ©è³‡æ–™ï¼ˆå¯èƒ½åœ¨åˆè¨ˆåˆ—æœ¬èº«ï¼Œæˆ–å³å´1-2åˆ—ï¼‰
                            let marginCol = totalCol;
                            let foundMargin = false;
                            
                            if (keyRows.marginAmount) {
                                // å…ˆæª¢æŸ¥åˆè¨ˆåˆ—æœ¬èº«
                                const totalColMargin = parseFloat(data[keyRows.marginAmount][totalCol]);
                                if (!isNaN(totalColMargin) && totalColMargin > 100) {
                                    marginCol = totalCol;
                                    foundMargin = true;
                                } else {
                                    // åœ¨åˆè¨ˆåˆ—å³å´1-3åˆ—ä¸­æœç´¢
                                    for (let c = totalCol + 1; c < Math.min(totalCol + 4, data[keyRows.marginAmount].length); c++) {
                                        const val = parseFloat(data[keyRows.marginAmount][c]);
                                        if (!isNaN(val) && val > 100) {
                                            marginCol = c;
                                            foundMargin = true;
                                            break;
                                        }
                                    }
                                    
                                    // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå¾€å·¦å´æœç´¢ï¼ˆé‡å°æŸäº›ç‰¹æ®Šæ ¼å¼ï¼‰
                                    if (!foundMargin) {
                                        for (let c = colIdx; c < totalCol; c++) {
                                            const val = parseFloat(data[keyRows.marginAmount][c]);
                                            if (!isNaN(val) && val > 100) {
                                                marginCol = c;
                                                foundMargin = true;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            storeColumns[displayName] = { col: totalCol, marginCol: marginCol };
                            
                            console.log(`${displayName}: æ¥­ç¸¾åˆ—=${totalCol}, æ¯›åˆ©åˆ—=${marginCol}, æ‰¾åˆ°æ¯›åˆ©=${foundMargin}`);
                        }
                    }
                }
                
                console.log('æ‰¾åˆ°çš„åº—å®¶åˆ—ä½ç½®ï¼š', storeColumns);
                
                // ========== æ­¥é©Ÿ3ï¼šæå–æ¯å®¶åº—çš„æ•¸æ“š ==========
                const results = [];
                const storeOrder = ['ä¸­æ¸¯', 'ä¸­å‹', 'å°ä¸­ä¸‰äº•', 'è€æ–¯', 'å‚æ¥Š'];
                
                storeOrder.forEach(storeName => {
                    if (!storeColumns[storeName]) {
                        console.warn(`æœªæ‰¾åˆ°åº—å®¶ï¼š${storeName}`);
                        return;
                    }
                    
                    const { col, marginCol } = storeColumns[storeName];
                    
                    // æå–æ•¸æ“š
                    const currentPerformance = parseFloat(data[keyRows.total][col]) || 0;
                    const targetPerformance = parseFloat(data[keyRows.target][col]) || 0;
                    const grossMarginTarget = keyRows.marginTarget ? (parseFloat(data[keyRows.marginTarget][marginCol]) || 0) : 0;
                    const grossMarginRate = keyRows.marginRate ? (parseFloat(data[keyRows.marginRate][marginCol]) || 0) : 0;
                    const grossMarginAmount = keyRows.marginAmount ? (parseFloat(data[keyRows.marginAmount][marginCol]) || 0) : 0;

                    // è¨ˆç®—é”æˆç‡å’Œå·®ç•°
                    const performanceRate = targetPerformance > 0 ? (currentPerformance / targetPerformance) * 100 : 0;
                    const performanceDiff = currentPerformance - targetPerformance;
                    const marginRate = grossMarginTarget > 0 ? (grossMarginAmount / grossMarginTarget) * 100 : 0;
                    const marginDiff = grossMarginAmount - grossMarginTarget;

                    results.push({
                        name: storeName,
                        currentPerformance,
                        targetPerformance,
                        performanceRate,
                        performanceDiff,
                        grossMarginAmount,
                        grossMarginTarget,
                        marginRate,
                        marginDiff,
                        grossMarginRate: grossMarginRate * 100
                    });
                    
                    console.log(`${storeName}æ•¸æ“šï¼š`, {
                        æ¥­ç¸¾: currentPerformance,
                        ç›®æ¨™: targetPerformance,
                        æ¯›åˆ©é¡: grossMarginAmount
                    });
                });

                displayResults(results);
            } catch (error) {
                console.error('è™•ç†éŒ¯èª¤ï¼š', error);
                showError('è³‡æ–™è™•ç†å¤±æ•—ï¼š' + error.message);
                loading.style.display = 'none';
            }
        }

        function displayResults(results) {
            dashboard.innerHTML = '';
            
            // è¨ˆç®—è²¡å¹´ä¿¡æ¯
            const fiscalInfo = calculateFiscalInfo();
            
            // è¨ˆç®—ç¸½å’Œ
            const totals = {
                name: 'ä¸­å€',
                currentPerformance: 0,
                targetPerformance: 0,
                grossMarginAmount: 0,
                grossMarginTarget: 0,
                performanceRate: 0,
                performanceDiff: 0,
                marginRate: 0,
                marginDiff: 0,
                grossMarginRate: 0
            };
            
            results.forEach(store => {
                totals.currentPerformance += store.currentPerformance;
                totals.targetPerformance += store.targetPerformance;
                totals.grossMarginAmount += store.grossMarginAmount;
                totals.grossMarginTarget += store.grossMarginTarget;
            });
            
            totals.performanceDiff = totals.currentPerformance - totals.targetPerformance;
            totals.performanceRate = totals.targetPerformance > 0 ? (totals.currentPerformance / totals.targetPerformance) * 100 : 0;
            totals.marginDiff = totals.grossMarginAmount - totals.grossMarginTarget;
            totals.marginRate = totals.grossMarginTarget > 0 ? (totals.grossMarginAmount / totals.grossMarginTarget) * 100 : 0;
            totals.grossMarginRate = totals.currentPerformance > 0 ? (totals.grossMarginAmount / totals.currentPerformance) * 100 : 0;
            
            // é¡¯ç¤ºæ—¥æœŸä¿¡æ¯
            displayDateInfo(fiscalInfo);
            
            // ç”Ÿæˆè¡¨æ ¼
            generateSummaryTable(results, totals);
            
            // å…ˆé¡¯ç¤ºç¸½å’Œå¡ç‰‡
            createStoreCard(totals, true, fiscalInfo);
            
            // å†é¡¯ç¤ºå„åº—å¡ç‰‡
            results.forEach(store => {
                createStoreCard(store, false, fiscalInfo);
            });

            loading.style.display = 'none';
            document.getElementById('summaryTable').style.display = 'block';
            dashboard.style.display = 'grid';
        }

        function displayDateInfo(fiscalInfo) {
            const dateInfoDiv = document.getElementById('dateInfo');
            dateInfoDiv.innerHTML = `
                <div class="main-date">
                    ğŸ“… FY${fiscalInfo.fiscalYear}Q${fiscalInfo.quarter}W${fiscalInfo.week} ${fiscalInfo.yesterday}
                </div>
                <div class="sub-date">
                    æœ¬æœˆå‰©é¤˜å¤©æ•¸ï¼š${fiscalInfo.remainingDays} å¤©
                </div>
            `;
        }

        function generateSummaryTable(results, totals) {
            const tableContent = document.getElementById('summaryTableContent');
            
            let html = `
                <thead>
                    <tr>
                        <th>åº—å®¶</th>
                        <th>ç›®æ¨™æ¥­ç¸¾</th>
                        <th>ç›®å‰æ¥­ç¸¾</th>
                        <th>é”æˆç‡</th>
                        <th>æ¥­ç¸¾å·®ç•°</th>
                        <th>æ¯›åˆ©é¡ç›®æ¨™</th>
                        <th>ç›®å‰æ¯›åˆ©é¡</th>
                        <th>æ¯›åˆ©é”æˆç‡</th>
                        <th>æ¯›åˆ©é¡å·®ç•°</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // å„åº—è³‡æ–™
            results.forEach(store => {
                const perfDiffClass = store.performanceDiff >= 0 ? 'positive-value' : 'negative-value';
                const perfRateClass = store.performanceRate >= 100 ? 'positive-value' : 'negative-value';
                const marginDiffClass = store.marginDiff >= 0 ? 'positive-value' : 'negative-value';
                const marginRateClass = store.marginRate >= 100 ? 'positive-value' : 'negative-value';
                
                html += `
                    <tr>
                        <td>${store.name}</td>
                        <td class="neutral-value">${formatNumber(store.targetPerformance)}</td>
                        <td class="neutral-value">${formatNumber(store.currentPerformance)}</td>
                        <td class="${perfRateClass}">${store.performanceRate.toFixed(1)}%</td>
                        <td class="${perfDiffClass}">${store.performanceDiff >= 0 ? '+' : ''}${formatNumber(store.performanceDiff)}</td>
                        <td class="neutral-value">${store.grossMarginTarget > 0 ? formatNumber(store.grossMarginTarget) : '-'}</td>
                        <td class="neutral-value">${store.grossMarginAmount > 0 ? formatNumber(store.grossMarginAmount) : '-'}</td>
                        <td class="${marginRateClass}">${store.grossMarginTarget > 0 ? store.marginRate.toFixed(1) + '%' : '-'}</td>
                        <td class="${marginDiffClass}">${store.grossMarginTarget > 0 ? (store.marginDiff >= 0 ? '+' : '') + formatNumber(store.marginDiff) : '-'}</td>
                    </tr>
                `;
            });
            
            // ç¸½è¨ˆè¡Œ
            const totalPerfDiffClass = totals.performanceDiff >= 0 ? 'positive-value' : 'negative-value';
            const totalPerfRateClass = totals.performanceRate >= 100 ? 'positive-value' : 'negative-value';
            const totalMarginDiffClass = totals.marginDiff >= 0 ? 'positive-value' : 'negative-value';
            const totalMarginRateClass = totals.marginRate >= 100 ? 'positive-value' : 'negative-value';
            
            html += `
                    <tr class="total-row">
                        <td>ä¸­å€ç¸½è¨ˆ</td>
                        <td>${formatNumber(totals.targetPerformance)}</td>
                        <td>${formatNumber(totals.currentPerformance)}</td>
                        <td class="${totalPerfRateClass}">${totals.performanceRate.toFixed(1)}%</td>
                        <td class="${totalPerfDiffClass}">${totals.performanceDiff >= 0 ? '+' : ''}${formatNumber(totals.performanceDiff)}</td>
                        <td>${formatNumber(totals.grossMarginTarget)}</td>
                        <td>${formatNumber(totals.grossMarginAmount)}</td>
                        <td class="${totalMarginRateClass}">${totals.marginRate.toFixed(1)}%</td>
                        <td class="${totalMarginDiffClass}">${totals.marginDiff >= 0 ? '+' : ''}${formatNumber(totals.marginDiff)}</td>
                    </tr>
                </tbody>
            `;
            
            tableContent.innerHTML = html;
        }

        function createStoreCard(store, isTotal, fiscalInfo) {
                const card = document.createElement('div');
                card.className = isTotal ? 'store-card total-card' : 'store-card';
                
                const performanceClass = store.performanceRate >= 100 ? 'positive' : 'negative';
                const marginClass = store.marginRate >= 100 ? 'positive' : 'negative';
                
                // è¨ˆç®—æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾ï¼ˆæ”¾åœ¨æœ€ä¸‹æ–¹ï¼‰
                let dailyTargetHtml = '';
                if (!isTotal && store.grossMarginTarget > 0 && store.grossMarginRate > 0 && fiscalInfo.remainingDays > 0) {
                    const marginGap = store.grossMarginTarget - store.grossMarginAmount;
                    if (marginGap > 0) {
                        const dailyTarget = (marginGap / (store.grossMarginRate / 100)) * 1.05 / fiscalInfo.remainingDays;
                        dailyTargetHtml = `
                            <div class="daily-target">
                                <div class="daily-target-label">æ¥­ç¸¾&æ¯›åˆ©ç›®æ¨™ 100% æ¯æ—¥éœ€åšå«ç¨…æ¥­ç¸¾</div>
                                <div class="daily-target-value">${formatNumber(dailyTarget)}</div>
                            </div>
                        `;
                    }
                }
                
                // å»ºç«‹æ¯›åˆ©é¡é”æˆç‡çš„ HTML
                let marginRateHtml = '';
                
                if (store.grossMarginTarget > 0) {
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡é”æˆç‡</div>
                            <div class="metric-value ${marginClass}">
                                ${store.marginRate.toFixed(1)}%
                                <span class="percentage ${marginClass}">
                                    ${store.marginRate >= 100 ? 'âœ“ é”æ¨™' : 'âœ— æœªé”æ¨™'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡ç›®æ¨™å·®ç•°</div>
                            <div>
                                <div class="metric-value ${marginClass}">
                                    ${store.marginDiff >= 0 ? '+' : ''}${formatNumber(store.marginDiff)}
                                </div>
                                <div class="amount">ç›®æ¨™: ${formatNumber(store.grossMarginTarget)} | å¯¦éš›: ${formatNumber(store.grossMarginAmount)}</div>
                            </div>
                        </div>
                    `;
                } else if (store.grossMarginAmount > 0) {
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">å¯¦éš›æ¯›åˆ©é¡</div>
                            <div>
                                <div class="metric-value neutral">
                                    ${formatNumber(store.grossMarginAmount)}
                                </div>
                                <div class="amount">ï¼ˆç„¡ç›®æ¨™è³‡æ–™ï¼‰</div>
                            </div>
                        </div>
                    `;
                } else {
                    marginRateHtml = `
                        <div class="metric-row">
                            <div class="metric-label">æ¯›åˆ©é¡è³‡æ–™</div>
                            <div class="metric-value" style="color: #999;">
                                ç„¡è³‡æ–™
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="store-name">${store.name}</div>
                    
                    <div class="metric-row">
                        <div class="metric-label">æ¥­ç¸¾é”æˆç‡</div>
                        <div class="metric-value ${performanceClass}">
                            ${store.performanceRate.toFixed(1)}%
                            <span class="percentage ${performanceClass}">
                                ${store.performanceRate >= 100 ? 'âœ“ é”æ¨™' : 'âœ— æœªé”æ¨™'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="metric-row">
                        <div class="metric-label">ç›®æ¨™æ¥­ç¸¾å·®ç•°</div>
                        <div>
                            <div class="metric-value ${performanceClass}">
                                ${store.performanceDiff >= 0 ? '+' : ''}${formatNumber(store.performanceDiff)}
                            </div>
                            <div class="amount">ç›®æ¨™: ${formatNumber(store.targetPerformance)} | ç›®å‰: ${formatNumber(store.currentPerformance)}</div>
                        </div>
                    </div>
                    
                    ${marginRateHtml}
                    
                    ${store.grossMarginRate > 0 ? `
                        <div class="metric-row">
                            <div class="metric-label">æ•´é«”æ¯›åˆ©ç‡</div>
                            <div class="metric-value neutral">
                                ${store.grossMarginRate.toFixed(2)}%
                            </div>
                        </div>
                    ` : ''}
                    
                    ${dailyTargetHtml}
                `;
                
                dashboard.appendChild(card);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
    </script>
</body>
</html>
